/* Vibe v3.0.0-Alpha12 | http://vibe-project.github.io/projects/vibe-javascript-client/ | (c) 2014, The Vibe Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(h,m){if("function"===typeof define&&define.amd)define([],function(){return m(h)});else if("object"===typeof exports){var v=require("jsdom").jsdom().parentWindow;v.WebSocket=require("ws");v.EventSource=require("eventsource");module.exports=m(v);module.exports.util.corsable=!0}else h.vibe=m(h)})(this,function(h){function m(b){var c,a,d,e,g,l,f=[],p=function(E,n){n=n||[];a=!b||[E,n];d=!0;l=e||0;e=0;for(g=f.length;l<g&&!c;l++)f[l].apply(E,n);d=!1};return{add:function(b){var l=f.length;f.push(b);
d?g=f.length:!c&&a&&!0!==a&&(e=l,p(a[0],a[1]))},remove:function(b){var a;for(a=0;a<f.length;a++)if(b===f[a]||b.guid&&b.guid===f[a].guid)d&&a<=g&&(g--,a<=l&&l--),f.splice(a--,1)},fire:function(e,g){c||d||b&&a||p(e,g)},lock:function(){c=!0},locked:function(){return!!c},unlock:function(){c=a=d=e=g=l=void 0}}}function v(b,c){var a={reconnect:function(a){return 2*(a||250)},transports:[F,G,H]};if(c)for(var d in c)a[d]=c[d];c=a;var e={},g={};e.on=function(a,b){var e;e=g[a];if(!e){if(g.message.locked())return this;
e=g[a]=m();e.order=g.message.order}e.add(b);return this};e.off=function(a,b){var e=g[a];e&&e.remove(b);return this};e.once=function(a,b){function c(){e.off(a,c);b.apply(e,arguments)}b.guid=b.guid||u++;c.guid=b.guid;return e.on(a,c)};e.fire=function(a){var b=g[a];b&&b.fire(e,z.call(arguments,1));return this};var l,r,p,h;e.open=function(){n="preparing";l=null;clearTimeout(r);h&&h++;for(var a in g)g[a].unlock();return e.fire("connecting")};e.close=function(){c.reconnect=!1;clearTimeout(r);l?l.close():
e.fire("close");return this};var n;e.state=function(){return n};for(d in{connecting:1,open:1,close:1,waiting:1})g[d]=m(!0),g[d].order=u++;g.message=m(!1);g.message.order=g.open.order;e.on("connecting",function(){n="connecting";for(var a=f.isArray(b)?z.call(b):[b],d=0;d<a.length;d++){var g=a[d]=f.makeAbsolute(a[d]);/^https?:/.test(g)&&!f.parseURI(g).query.transport&&a.splice(d,1,g.replace(/^http/,"ws"),f.stringifyURI(g,{transport:"stream"}),f.stringifyURI(g,{transport:"longpoll"}))}(function w(){function b(){g.off("close",
w).close()}var d=a.shift();if(d){for(var g,r=0;r<c.transports.length&&!(g=c.transports[r](d,c));r++);g?(e.once("close",b),g.open().on("close",w).on("text",function M(a){g.off("text",M);a=f.parseURI(a).query;c.heartbeat=+a.heartbeat;c._heartbeat=+a._heartbeat||5E3;l=g.off("close",w);var d;l.on("text",function(a){if(d){var b=f.parseJSON(a),c;a=function(a){return function(d){c||(c=!0,e.send("reply",{id:b.id,data:d,exception:!a}))}};a=[b.type,b.data,b.reply?{resolve:a(!0),reject:a(!1)}:null];e.fire.apply(e,
a)}else d=!0}).on("error",function(a){e.fire("error",a)}).on("close",function(){e.fire("close")});e.off("close",b).fire("open")})):w()}else e.fire("error",Error()).fire("close")})()}).on("open",function(){n="opened";var a;(function L(){a=setTimeout(function(){e.send("heartbeat").once("heartbeat",function(){clearTimeout(a);L()});a=setTimeout(function(){e.fire("error",Error("heartbeat"));l.close()},c._heartbeat)},c.heartbeat-c._heartbeat)})();e.once("close",function(){clearTimeout(a)});g.connecting.lock();
r=p=h=null}).on("close",function(){n="closed";for(var a in g){var b=g[a];b.order<g.close.order&&b.lock()}if(c.reconnect)e.once("close",function(){h=h||1;p=c.reconnect.call(e,p,h);!1!==p&&(r=setTimeout(function(){e.open()},p),e.fire("waiting",p,h))})}).on("waiting",function(){n="waiting"});var A={};e.send=function(a,b,d,c){if("opened"!==n)return e.fire(Error("notopened")),this;a={id:u++,type:a,data:b,reply:!(!d&&!c)};a.reply&&(A[a.id]=[d,c]);l.send(f.stringifyJSON(a));return this};e.on("reply",function(a){A[a.id][+a.exception].call(e,
a.data);delete A[a.id]});return e.open()}function I(b,c){var a=c&&c.timeout||3E3,d={open:function(){function b(){clearTimeout(e)}d.connect();var e=setTimeout(function(){d.fire("error",Error("timeout")).close()},a);d.on("open",b).on("close",b);return this}},e={open:m(!0),text:m(),binary:m(),error:m(),close:m(!0)};d.on=function(a,b){e[a].add(b);return this};d.off=function(a,b){e[a].remove(b);return this};d.fire=function(a){e[a].fire(d,z.call(arguments,1));return this};return d}function F(b,c){var a=
h.WebSocket;if(a&&/^wss?:/.test(b)){var d,e=I(b,c);e.connect=function(){d=new a(b);d.binaryType="arraybuffer";d.onopen=function(){e.fire("open")};d.onmessage=function(a){"string"===typeof a.data?e.fire("text",a.data):e.fire("binary",a.data)};d.onerror=function(){e.fire("error",Error()).fire("close")};d.onclose=function(){e.fire("close")}};e.send=function(a){d.send(a);return this};e.close=function(){d.close();return this};return e}}function B(b,c){var a=c&&c.xdrURL,d=I(b,c),e;d.on("open",function(){e=
f.stringifyURI(b,{id:d.id})}).on("close",function(){e=null});d.send=!f.crossOrigin(b)||f.corsable?function(a){var b=f.createXMLHttpRequest();b.onreadystatechange=function(){4===b.readyState&&200!==b.status&&e&&d.send(a)};b.open("POST",e);f.corsable&&(b.withCredentials=!0);"string"===typeof a?(b.setRequestHeader("content-type","text/plain; charset=UTF-8"),b.send("data="+a)):(b.setRequestHeader("content-type","application/octet-stream"),b.send(a));return this}:h.XDomainRequest&&a?function(b){var c=
new h.XDomainRequest;c.onerror=function(){e&&d.send(b)};c.open("POST",a.call(d,e));c.send("data="+b);return this}:function(a){var b,c=q.createElement("form");c.action=e;c.target="socket-"+u++;c.method="POST";c.enctype=c.encoding="text/plain";c.acceptCharset="UTF-8";c.style.display="none";c.innerHTML='<textarea name="data"></textarea><iframe name="'+c.target+'"></iframe>';c.firstChild.value=a;b=c.lastChild;f.on(b,"error",function(){e&&d.send(a)});f.on(b,"load",function(){q.body.removeChild(c)});q.body.appendChild(c);
c.submit();return this};var g;d.close=function(){d.abort();if(!g){g=!0;var a=q.createElement("script");a.async=!1;a.src=f.stringifyURI(b,{id:d.id,when:"abort"});a.onload=a.onerror=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),d.fire("close")};x.insertBefore(a,x.firstChild)}return this};return d}function G(b,c){if(/^https?:/.test(b)&&"stream"===f.parseURI(b).query.transport)return N(b,
c)||O(b,c)||P(b,c)||Q(b,c)}function N(b,c){var a=h.EventSource;if(a&&!(f.crossOrigin(b)&&f.browser.safari&&7>f.browser.vmajor)){var d,e=B(b,c);e.connect=function(){d=new a(b+"&when=open&sse=true",{withCredentials:!0});var c;d.onmessage=function(a){c?e.fire("text",a.data):(c=!0,a=f.parseURI(a.data).query,e.id=a.id,e.fire("open"))};d.onerror=function(){d.close();e.fire("close")}};e.abort=function(){d.close()};return e}}function C(b,c){var a="",d=B(b,c),e;d.parse=function(b){if(b=b.replace(/^\s+/,"")){b=
(a+b).split("\n\n");for(var c=0;c<b.length-1;c++){var h=b[c].substring(6);e?d.fire("text",h):(e=!0,h=f.parseURI(h).query,d.id=h.id,d.fire("open"))}a=b[b.length-1]}};return d}function O(b,c){if(!(f.browser.msie&&10>f.browser.vmajor||f.crossOrigin(b)&&!f.corsable)){var a,d=C(b,c);d.connect=function(){var c;a=f.createXMLHttpRequest();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(d.parse(c?a.responseText.substring(c):a.responseText),c=a.responseText.length):4===a.readyState&&(200!==
a.status&&d.fire("error",Error()),d.fire("close"))};a.open("GET",b+"&when=open");f.corsable&&(a.withCredentials=!0);a.send()};d.abort=function(){a.abort()};return d}}function P(b,c){var a=c&&c.xdrURL,d=h.XDomainRequest;if(a&&d){var e,g=C(b,c);g.connect=function(){var c;e=new d;e.onprogress=function(){g.parse(c?e.responseText.substring(c):e.responseText);c=e.responseText.length};e.onerror=function(){g.fire("error",Error()).fire("close")};e.onload=function(){g.fire("close")};e.open("GET",a.call(g,b+
"&when=open"));e.send()};g.abort=function(){e.abort()};return g}}function Q(b,c){var a=h.ActiveXObject;if(a&&!f.crossOrigin(b)){var d,e,g=C(b,c);g.connect=function(){function c(a){var b;(function k(){b=setTimeout(function(){!1!==a()&&k()},1)})();return function(){clearTimeout(b)}}d=new a("htmlfile");d.open();d.close();var f=d.createElement("iframe");f.src=b+"&when=open";d.body.appendChild(f);var h=f.contentDocument||f.contentWindow.document;e=c(function(){function a(){var c=b.cloneNode(!0);c.appendChild(h.createTextNode("."));
c=c.innerText.replace(/\r\n/g,"\n");return c.substring(0,c.length-1)}if(h.firstChild){var b=h.body.lastChild;if(!b)return g.fire("error",Error()).fire("close"),!1;g.parse(a());b.innerText="";e=c(function(){var c=a();c&&(b.innerText="",g.parse(c));if("complete"===h.readyState)return g.fire("close"),!1});return!1}})};g.abort=function(){e();d.execCommand("Stop")};return g}}function H(b,c){if(/^https?:/.test(b)&&"longpoll"===f.parseURI(b).query.transport)return R(b,c)||S(b,c)||T(b,c)}function D(b,c){var a=
B(b,c);a.connect=function(){a.poll(b+"&when=open",function(c){c=f.parseURI(c).query;a.id=c.id;(function g(){a.poll(f.stringifyURI(b,{id:a.id,when:"poll"}),function(b){b?(g(),"string"===typeof b?a.fire("text",b):a.fire("binary",b)):a.fire("close")})})();a.fire("open")})};return a}function R(b,c){if(!f.crossOrigin(b)||f.corsable){var a,d=D(b,c);d.poll=function(b,c){a=f.createXMLHttpRequest();a.onreadystatechange=function(){switch(a.readyState){case 2:"application/octet-stream"===a.getResponseHeader("content-type")&&
(a.responseType="arraybuffer");break;case 4:200===a.status?c(a.response||a.responseText):d.fire("error",Error()).fire("close")}};a.open("GET",b);f.corsable&&(a.withCredentials=!0);a.send(null)};d.abort=function(){a.abort()};return d}}function S(b,c){var a=c&&c.xdrURL,d=h.XDomainRequest;if(a&&d){var e,g=D(b,c);g.poll=function(b,c){b=a.call(g,b);e=new d;e.onload=function(){c(e.responseText)};e.onerror=function(){g.fire("error",Error()).fire("close")};e.open("GET",b);e.send()};g.abort=function(){e.abort()};
return g}}function T(b,c){var a,d=D(b,c),e=J.pop()||"socket_"+u++;h[e]=function(b){a.responseText=b};d.on("close",function(){h[e]=function(){};J.push(e)});d.poll=function(b,c){a=q.createElement("script");a.async=!0;a.src=f.stringifyURI(b,{jsonp:"true",callback:e});a.clean=function(){a.clean=a.onerror=a.onreadystatechange=a.responseText=null;a.parentNode&&a.parentNode.removeChild(a)};a.onreadystatechange=function(){/loaded|complete/.test(a.readyState)&&(a.clean&&a.clean(),c(a.responseText),a.responseText=
null)};a.onerror=function(){a.clean();d.fire("error",Error()).fire("close")};x.insertBefore(a,x.firstChild)};d.abort=function(){a.clean&&a.clean()};return d}var u=1,z=Array.prototype.slice,K=Object.prototype.toString,U=Object.prototype.hasOwnProperty,q=h.document,y=h.location,V=h.navigator,x=q.head||q.getElementsByTagName("head")[0]||q.documentElement,f={};f.isArray=Array.isArray||function(b){return"[object Array]"===K.call(b)};f.makeAbsolute=function(b){var c=q.createElement("div");c.innerHTML='<a href="'+
b+'"/>';return encodeURI(decodeURI(c.firstChild.href))};f.on=function(b,c,a){b.addEventListener?b.addEventListener(c,a,!1):b.attachEvent&&b.attachEvent("on"+c,a)};f.stringifyURI=function(b,c){var a,d=[];c=c||{};c._=u++;for(a in c)null!=c[a]&&d.push(encodeURIComponent(a)+"="+encodeURIComponent(c[a]));return b+(/\?/.test(b)?"&":"?")+d.join("&").replace(/%20/g,"+")};f.parseURI=function(b){var c={query:{}};if(b=/.*\?([^#]*)/.exec(b)){b=b[1].split("&");for(var a=0;a<b.length;a++){var d=b[a].split("=");
c.query[decodeURIComponent(d[0])]=decodeURIComponent(d[1]||"")}}return c};f.createXMLHttpRequest=function(){try{return new h.XMLHttpRequest}catch(b){try{return new h.ActiveXObject("Microsoft.XMLHTTP")}catch(c){}}};f.parseJSON=h.JSON?h.JSON.parse:function(b){return Function("return "+b)()};f.stringifyJSON=h.JSON?h.JSON.stringify:function(b){function c(a){return'"'+a.replace(d,function(a){var b=e[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function a(a){return 10>
a?"0"+a:a}var d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function l(b,e){var d,f,h,k=e[b];h=typeof k;k&&"object"===typeof k&&"function"===typeof k.toJSON&&(k=k.toJSON(b),h=typeof k);switch(h){case "string":return c(k);case "number":return isFinite(k)?String(k):"null";case "boolean":return String(k);case "object":if(!k)return"null";
switch(K.call(k)){case "[object Date]":return isFinite(k.valueOf())?'"'+k.getUTCFullYear()+"-"+a(k.getUTCMonth()+1)+"-"+a(k.getUTCDate())+"T"+a(k.getUTCHours())+":"+a(k.getUTCMinutes())+":"+a(k.getUTCSeconds())+'Z"':"null";case "[object Array]":f=k.length;h=[];for(d=0;d<f;d++)h.push(l(d,k)||"null");return"["+h.join(",")+"]";default:h=[];for(d in k)U.call(k,d)&&(f=l(d,k))&&h.push(c(d)+":"+f);return"{"+h.join(",")+"}"}}}("",{"":b})};f.corsable="withCredentials"in f.createXMLHttpRequest();f.browser=
function(){var b=V.userAgent.toLowerCase(),c={},b=/(msie) ([\w.]+)/.exec(b)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(b)||0>b.indexOf("android")&&/version\/(.+) (safari)/.exec(b)||[];"safari"===b[2]&&(b[2]=b[1],b[1]="safari");c[b[1]||""]=!0;c.version=b[2]||"0";c.vmajor=c.version.split(".")[0];c.trident&&(c.msie=!0);return c}();f.crossOrigin=function(b){b=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(b.toLowerCase());return!(!b||b[1]==y.protocol&&b[2]==y.hostname&&(b[3]||("http:"===b[1]?80:443))==
(y.port||("http:"===y.protocol?80:443)))};var J=[],t=[];f.on(h,"unload",function(){for(var b,c=0;c<t.length;c++)b=t[c],"closed"!==b.state()&&b.close()});f.on(h,"online",function(){for(var b,c=0;c<t.length;c++)b=t[c],"waiting"===b.state()&&b.open()});f.on(h,"offline",function(){for(var b,c=0;c<t.length;c++)b=t[c],"opened"===b.state()&&b.fire("error",Error()).fire("close")});return{open:function(b,c){var a=v(b,c);t.push(a);return a},transport:{createWebSocketTransport:F,createHttpStreamTransport:G,
createHttpLongpollTransport:H},util:f}});