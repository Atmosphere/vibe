/* Vibe v3.0.0-Alpha2 | http://vibe-project.github.io/projects/vibe-javascript-client/ | (c) 2014, The Vibe Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(k,t){if("function"===typeof define&&define.amd)define([],function(){return t(k)});else if("object"===typeof exports){var y=require("jsdom").jsdom().parentWindow;y.WebSocket=require("ws");y.EventSource=require("eventsource");module.exports=t(y);module.exports.util.corsable=!0}else k.vibe=t(k)})(this,function(k){function t(c){var b,a,h,g,d,e,m=[],k=function(k,r){r=r||[];a=!c||[k,r];h=!0;e=g||0;g=0;for(d=m.length;e<d&&!b;e++)m[e].apply(k,r);h=!1};return{add:function(c){var e=m.length;m.push(c);
h?d=m.length:!b&&a&&!0!==a&&(g=e,k(a[0],a[1]))},remove:function(a){var b;for(b=0;b<m.length;b++)if(a===m[b]||a.guid&&a.guid===m[b].guid)h&&b<=d&&(d--,b<=e&&e--),m.splice(b--,1)},fire:function(d,g){b||h||c&&a||k(d,g)},lock:function(){b=!0},locked:function(){return!!b},unlock:function(){b=a=h=g=d=e=void 0}}}function y(c,b){c=e.makeAbsolute(c);var a,h=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(c.toLowerCase()),g={reconnect:function(a){return 2*(a||250)},sharing:!1,timeout:!1,transports:null,
xdrURL:null};if(b)for(a in b)g[a]=b[a];b=g;b.url=c;b.crossOrigin=!(!h||h[1]==z.protocol&&h[2]==z.hostname&&(h[3]||("http:"===h[1]?80:443))==(z.port||("http:"===z.protocol?80:443)));var d={},f={};d.on=function(a,b){var c;c=f[a];if(!c){if(f.message.locked())return this;c=f[a]=t();c.order=f.message.order}c.add(b);return this};d.off=function(a,b){var c=f[a];c&&c.remove(b);return this};d.once=function(a,b){function c(){d.off(a,c);b.apply(d,arguments)}b.guid=b.guid||u++;c.guid=b.guid;return d.on(a,c)};
d.fire=function(a){var b=f[a];b&&b.fire(d,G.call(arguments,1));return this};var m;d.state=function(){return m};for(a in{connecting:1,open:1,close:1,waiting:1})f[a]=t(!0),f[a].order=u++;f.message=t(!1);f.message.order=f.open.order;d.on("connecting",function(){function a(){clearTimeout(h)}function g(){function a(b){b=e.parseJSON(b);if("p"===b.target)switch(b.type){case "send":b=e.parseJSON(b.data);d.send(b.type,b.data);break;case "close":d.close()}}function h(b){f.broadcast({target:"c",type:"message",
data:b})}function l(){n.cookie=encodeURIComponent(s)+"="+encodeURIComponent(e.stringifyJSON({ts:e.now(),heir:(f.get("children")||[])[0]}))+"; path=/"}var r,f,s="socket-"+c,m={storage:function(){var b=k.localStorage;if(!e.browser.msie)return{init:function(){function c(b){b.key===s&&b.newValue&&a(b.newValue)}e.on(k,"storage",c);d.once("close",function(){e.off(k,"storage",c);d.once("close",function(){b.removeItem(s);b.removeItem(s+"-opened");b.removeItem(s+"-children")})})},broadcast:function(c){var d=
e.stringifyJSON(c);b.setItem(s,d);setTimeout(function(){a(d)},50)},get:function(a){return e.parseJSON(b.getItem(s+"-"+a))},set:function(a,c){b.setItem(s+"-"+a,e.stringifyJSON(c))}}},windowref:function(){var b=s.replace(/\W/g,""),c=n.getElementById(b),d;c||(c=n.createElement("div"),c.id=b,c.style.display="none",c.innerHTML='<iframe name="'+b+'" />',n.body.appendChild(c));d=c.firstChild.contentWindow;return{init:function(){d.callbacks=[a];d.fire=function(b){var a;for(a=0;a<d.callbacks.length;a++)d.callbacks[a](b)}},
broadcast:function(b){!d.closed&&d.fire&&d.fire(e.stringifyJSON(b))},get:function(b){return d.closed?null:d[b]},set:function(b,a){d.closed||(d[b]=a)}}}};f=m.storage()||m.windowref();f.init();f.set("children",[]);f.set("opened",!1);l();r=setInterval(l,1E3);d.on("_message",h).once("open",function(){f.set("opened",!0);f.broadcast({target:"c",type:"open"})}).once("close",function(a){clearInterval(r);n.cookie=encodeURIComponent(s)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";f.broadcast({target:"c",
type:"close",data:{reason:a,heir:A?(f.get("children")||[])[0]:b.id}});d.off("_message",h)})}m="connecting";var h;0<b.timeout&&(h=setTimeout(function(){d.fire("close","timeout");p.close()},b.timeout),d.once("open",a).once("close",a));b.sharing&&!D&&g()}).on("open",function(){function a(){c=setTimeout(function(){d.send("heartbeat").once("heartbeat",function(){clearTimeout(c);a()});c=setTimeout(function(){d.fire("close","error");p.close()},b._heartbeat)},b.heartbeat-b._heartbeat)}m="opened";var c;b.heartbeat>
b._heartbeat&&(a(),d.once("close",function(){clearTimeout(c)}));f.connecting.lock();r=w=l=null}).on("close",function(){m="closed";var a,c,g=f.close.order;for(a in f)c=f[a],c.order<g&&c.lock();if(b.reconnect)d.once("close",function(){l=l||1;w=b.reconnect.call(d,w,l);!1!==w&&(r=setTimeout(function(){d.open()},w),d.fire("waiting",w,l))})}).on("waiting",function(){m="waiting"});var p,D,r,w,l;d.open=function(){var a;clearTimeout(r);for(a in f)f[a].unlock();p=D=null;m="preparing";l&&l++;(function(a,c){var d=
e.url(b.url,{when:"handshake"});if(!b.crossOrigin||e.corsable){var g=e.xhr();g.onreadystatechange=function(){4===g.readyState&&(200===g.status?a(e.parseJSON(g.responseText)):c())};g.open("GET",d);e.corsable&&(g.withCredentials=!0);g.send(null)}else{var h=B.pop()||"socket_"+u++;k[h]=function(b){a(e.parseJSON(b));k[h]=null;B.push(h)};var f=n.createElement("script");f.async=!0;f.src=d+"&callback="+h;f.onload=f.onreadystatechange=function(){if(!f.readyState||/loaded|complete/.test(f.readyState))f.onload=
f.onreadystatechange=null,f.parentNode&&f.parentNode.removeChild(f)};x.insertBefore(f,x.firstChild)}})(function(c){b.id=c.id;b.heartbeat=c.heartbeat;b.transports||(b.transports=c.transports);c._heartbeat&&(b._heartbeat=c._heartbeat);c=G.call(b.transports);for(b.sharing&&c.unshift("session");!p&&c.length;)switch(a=c.shift(),a){case "stream":c.unshift("sse","streamxhr","streamxdr","streamiframe");break;case "longpoll":c.unshift("longpollajax","longpollxdr","longpolljsonp");break;default:p=q[a](d,b)}p?
(b.transport=a,D="session"===a,d.fire("connecting"),p.open()):d.fire("close","notransport")},function(){d.fire("close","error")});return this};d.close=function(){b.reconnect=!1;clearTimeout(r);d.fire("close",A?"error":"aborted");p&&p.close();return this};var E={};d.send=function(a,b,c,d){if("opened"!==m)throw Error("A socket is not open yet");a={id:u++,type:a,data:b,reply:!(!c&&!d)};a.reply&&(E[a.id]=[c,d]);p.send(e.stringifyJSON(a));return this};d.receive=function(a){var b,c=e.parseJSON(a);a=[c.type,
c.data,c.reply?{resolve:function(a){b||(b=!0,d.send("reply",{id:c.id,data:a,exception:!1}))},reject:function(a){b||(b=!0,d.send("reply",{id:c.id,data:a,exception:!0}))}}:null];return d.fire.apply(d,a).fire("_message",a)};d.on("reply",function(a){E[a.id][+a.exception].call(d,a.data);delete E[a.id]});return d.open()}var u=1,A,G=Array.prototype.slice,F=Object.prototype.toString,H=Object.prototype.hasOwnProperty,n=k.document,z=k.location,I=k.navigator,e,B=[],x=n.head||n.getElementsByTagName("head")[0]||
n.documentElement;e={now:Date.now||function(){return+new Date},isArray:Array.isArray||function(c){return"[object Array]"===F.call(c)},isFunction:function(c){return"[object Function]"===F.call(c)},makeAbsolute:function(c){var b=n.createElement("div");b.innerHTML='<a href="'+c+'"/>';return encodeURI(decodeURI(b.firstChild.href))},on:function(c,b,a){c.addEventListener?c.addEventListener(b,a,!1):c.attachEvent&&c.attachEvent("on"+b,a)},off:function(c,b,a){c.removeEventListener?c.removeEventListener(b,
a,!1):c.detachEvent&&c.detachEvent("on"+b,a)},url:function(c,b){var a,h=[];b=b||{};b._=u++;for(a in b)h.push(encodeURIComponent(a)+"="+encodeURIComponent(b[a]));return c+(/\?/.test(c)?"&":"?")+h.join("&").replace(/%20/g,"+")},xhr:function(){try{return new k.XMLHttpRequest}catch(c){try{return new k.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}},parseJSON:k.JSON?k.JSON.parse:function(c){return Function("return "+c)()},stringifyJSON:k.JSON?k.JSON.stringify:function(c){function b(a){return'"'+a.replace(h,
function(a){var b=g[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function a(a){return 10>a?"0"+a:a}var h=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,g={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function f(c,g){var h,e,k,l=g[c];k=typeof l;l&&"object"===typeof l&&"function"===typeof l.toJSON&&(l=l.toJSON(c),k=typeof l);switch(k){case "string":return b(l);
case "number":return isFinite(l)?String(l):"null";case "boolean":return String(l);case "object":if(!l)return"null";switch(F.call(l)){case "[object Date]":return isFinite(l.valueOf())?'"'+l.getUTCFullYear()+"-"+a(l.getUTCMonth()+1)+"-"+a(l.getUTCDate())+"T"+a(l.getUTCHours())+":"+a(l.getUTCMinutes())+":"+a(l.getUTCSeconds())+'Z"':"null";case "[object Array]":e=l.length;k=[];for(h=0;h<e;h++)k.push(f(h,l)||"null");return"["+k.join(",")+"]";default:k=[];for(h in l)H.call(l,h)&&(e=f(h,l))&&k.push(b(h)+
":"+e);return"{"+k.join(",")+"}"}}}("",{"":c})}};e.corsable="withCredentials"in e.xhr();e.browser=function(){var c=I.userAgent.toLowerCase(),b={},c=/(msie) ([\w.]+)/.exec(c)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(c)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(c)||0>c.indexOf("android")&&/version\/(.+) (safari)/.exec(c)||[];b[c[1]||""]=!0;b.version=c[2]||"0";b.vmajor=b.version.split(".")[0];b.trident&&(b.msie=!0);return b}();var q={session:function(c,b){function a(a,b){var c,d=a.length;for(c=0;c<d;c++)a[c]===
b&&a.splice(c,1);return d!==a.length}function h(a){a=e.parseJSON(a);var d=a.data;if("c"===a.target)switch(a.type){case "open":c.fire("open");break;case "close":f||(f=!0,"aborted"===d.reason?c.close():d.heir===b.id?c.fire("close",d.reason):setTimeout(function(){c.fire("close",d.reason)},100));break;case "message":if("connecting"===c.state())c.once("open",function(){c.fire.apply(c,d)});else c.fire.apply(c,d)}}function g(){var a=(new RegExp("(?:^|; )("+encodeURIComponent(p)+")=([^;]*)")).exec(n.cookie);
if(a)return e.parseJSON(decodeURIComponent(a[2]))}var d,f,m,p="socket-"+b.url,q={storage:function(){if(!e.browser.msie){var d=k.localStorage,g=function(a){return e.parseJSON(d.getItem(p+"-"+a))},f=function(a,b){d.setItem(p+"-"+a,e.stringifyJSON(b))};return{init:function(){function d(a){a.key===p&&a.newValue&&h(a.newValue)}f("children",g("children").concat([b.id]));e.on(k,"storage",d);c.once("close",function(){var c=g("children");e.off(k,"storage",d);c&&a(c,b.id)&&f("children",c)});return g("opened")},
broadcast:function(a){var b=e.stringifyJSON(a);d.setItem(p,b);setTimeout(function(){h(b)},50)}}}},windowref:function(){var d=k.open("",p.replace(/\W/g,""));if(d&&!d.closed&&d.callbacks)return{init:function(){d.callbacks.push(h);d.children.push(b.id);c.once("close",function(){f||(a(d.callbacks,h),a(d.children,b.id))});return d.opened},broadcast:function(a){!d.closed&&d.fire&&d.fire(e.stringifyJSON(a))}}}};if((d=g())&&!(1E3<e.now()-d.ts)&&(m=q.storage()||q.windowref()))return{open:function(){var a,
f=b.timeout,k=b.heartbeat;b.timeout=b.heartbeat=!1;a=setInterval(function(){var a=d;(d=g())&&a.ts!==d.ts||h(e.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:a.heir}}))},1E3);c.once("close",function(){clearInterval(a);b.timeout=f;b.heartbeat=k});m.init()&&setTimeout(function(){c.fire("open")},50)},send:function(a){m.broadcast({target:"p",type:"send",data:a})},close:function(){A||m.broadcast({target:"p",type:"close"})}}},base:function(c,b){var a={uri:{open:function(){return e.url(b.url,
{id:b.id,when:"open",transport:b.transport})}},close:function(){a.abort();var c=n.createElement("script");c.async=!1;c.src=e.url(b.url,{id:b.id,when:"abort"});c.onload=c.onreadystatechange=function(){if(!c.readyState||/loaded|complete/.test(c.readyState))c.onload=c.onreadystatechange=null,c.parentNode&&c.parentNode.removeChild(c)};x.insertBefore(c,x.firstChild)}};return a},ws:function(c,b){var a,h=k.WebSocket,g=q.base(c,b);if(h)return g.open=function(){var b=g.uri.open().replace(/^http/,"ws");a=new h(b);
a.onopen=function(){c.fire("open")};a.onmessage=function(a){c.receive(a.data)};a.onerror=function(){c.fire("close","error")};a.onclose=function(a){c.fire("close",a.wasClean?"done":"error")}},g.send=function(b){a.send(b)},g.abort=function(){a.close()},g},httpbase:function(c,b){var a=q.base(c,b);a.send=!b.crossOrigin||e.corsable?function(a){var c=e.xhr();c.open("POST",e.url(b.url,{id:b.id}));c.setRequestHeader("content-type","text/plain; charset=UTF-8");e.corsable&&(c.withCredentials=!0);c.send("data="+
a)}:k.XDomainRequest&&b.xdrURL?function(a){var g=new k.XDomainRequest;g.open("POST",b.xdrURL.call(c,e.url(b.url,{id:b.id})));g.send("data="+a)}:function(a){var c=n.createElement("form");c.action=e.url(b.url,{id:b.id});c.target="socket-"+u++;c.method="POST";c.enctype=c.encoding="text/plain";c.acceptCharset="UTF-8";c.style.display="none";c.innerHTML='<textarea name="data"></textarea><iframe name="'+c.target+'"></iframe>';c.firstChild.value=a;e.on(c.lastChild,"load",function(){n.body.removeChild(c)});
n.body.appendChild(c);c.submit()};return a},sse:function(c,b){var a,h=k.EventSource,g=q.httpbase(c,b);if(h&&!(b.crossOrigin&&e.browser.safari&&7>e.browser.vmajor))return g.open=function(){var b=g.uri.open();a=new h(b,{withCredentials:!0});a.onopen=function(){c.fire("open")};a.onmessage=function(a){c.receive(a.data)};a.onerror=function(){a.close();c.fire("close","done")}},g.abort=function(){a.close()},g},streambase:function(c,b){var a="",h=q.httpbase(c,b);h.parse=function(b){if(b=b.replace(/^\s+/,
"")){var d=(a+b).split("\n\n");for(b=0;b<d.length-1;b++)c.receive(d[b].substring(6));a=d[d.length-1]}};return h},streamxhr:function(c,b){var a,h=q.streambase(c,b);if(!(e.browser.msie&&10>e.browser.vmajor||e.browser.opera&&13>e.browser.vmajor||b.crossOrigin&&!e.corsable))return h.open=function(){var b,d,f=h.uri.open();a=e.xhr();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(d=a.responseText.length,b?d>b&&h.parse(a.responseText.substring(b)):(c.fire("open"),h.parse(a.responseText)),
b=d):4===a.readyState&&c.fire("close",200===a.status?"done":"error")};a.open("GET",f);e.corsable&&(a.withCredentials=!0);a.send(null)},h.abort=function(){a.abort()},h},streamxdr:function(c,b){var a,h=k.XDomainRequest,e=q.streambase(c,b);if(h&&b.xdrURL)return e.open=function(){var d,f,k=b.xdrURL.call(c,e.uri.open());a=new h;a.onprogress=function(){f=a.responseText.length;d?e.parse(a.responseText.substring(d)):(c.fire("open"),e.parse(a.responseText));d=f};a.onerror=function(){c.fire("close","error")};
a.onload=function(){c.fire("close","done")};a.open("GET",k);a.send()},e.abort=function(){a.abort()},e},streamiframe:function(c,b){var a,e,g=k.ActiveXObject,d=q.streambase(c,b);if(g&&!b.crossOrigin){try{new g("htmlfile")}catch(f){return}d.open=function(){function b(a){var c;(function s(){c=setTimeout(function(){!1!==a()&&s()},1)})();return function(){clearTimeout(c)}}var f,k,n=d.uri.open();a=new g("htmlfile");a.open();a.close();f=a.createElement("iframe");f.src=n;a.body.appendChild(f);k=f.contentDocument||
f.contentWindow.document;e=b(function(){function a(){var c;c=f.cloneNode(!0);c.appendChild(k.createTextNode("."));c=c.innerText.replace(/\r\n/g,"\n");return c.substring(0,c.length-1)}var f;if(k.firstChild){f=k.body.lastChild;if(!f)return c.fire("close","error"),!1;c.fire("open");d.parse(a());f.innerText="";e=b(function(){var b=a();b&&(f.innerText="",d.parse(b));if("complete"===k.readyState)return c.fire("close","done"),!1});return!1}})};d.abort=function(){e();a.execCommand("Stop")};return d}},longpollbase:function(c,
b){var a=q.httpbase(c,b);a.uri.poll=function(a){return e.url(b.url,{id:b.id,when:"poll",lastEventIds:a.join(",")})};a.open=function(){a.connect(a.uri.open(),function(){function b(g){a.connect(a.uri.poll(g),function(a){if(a){var f=[];a=e.parseJSON(a);var g=e.isArray(a)?a:[a];for(a=0;a<g.length;a++)f.push(g[a].id);b(f);for(a=0;a<g.length;a++)c.receive(e.stringifyJSON(g[a]))}else c.fire("close","done")})}b([]);c.fire("open")})};return a},longpollajax:function(c,b){var a,h=q.longpollbase(c,b);if(!b.crossOrigin||
e.corsable)return h.connect=function(b,d){a=e.xhr();a.onreadystatechange=function(){4===a.readyState&&(200===a.status?d(a.responseText):c.fire("close","error"))};a.open("GET",b);e.corsable&&(a.withCredentials=!0);a.send(null)},h.abort=function(){a.abort()},h},longpollxdr:function(c,b){var a,e=k.XDomainRequest,g=q.longpollbase(c,b);if(e&&b.xdrURL)return g.connect=function(d,f){d=b.xdrURL.call(c,d);a=new e;a.onload=function(){f(a.responseText)};a.onerror=function(){c.fire("close","error")};a.open("GET",
d);a.send()},g.abort=function(){a.abort()},g},longpolljsonp:function(c,b){var a,e=B.pop()||"socket_"+u++,g=q.longpollbase(c,b);k[e]=function(b){a.responseText=b};c.once("close",function(){k[e]=function(){};B.push(e)});g.uri._open=g.uri.open;g.uri.open=function(){return g.uri._open.apply(g,arguments)+"&callback="+e};g.connect=function(b,e){a=n.createElement("script");a.async=!0;a.src=b;a.clean=function(){a.clean=a.onerror=a.onload=a.onreadystatechange=null;a.parentNode&&a.parentNode.removeChild(a)};
a.onload=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.clean&&a.clean(),e(a.responseText)};a.onerror=function(){a.clean();c.fire("close","error")};x.insertBefore(a,x.firstChild)};g.abort=function(){a.clean&&a.clean()};return g}},C={},v=[];C.open=function(c,b){var a=y(c,b);v.push(a);return a};C.util=e;C.transports=q;e.on(k,"unload",function(){A=!0;var c,b;for(c=0;c<v.length;c++)b=v[c],"closed"!==b.state()&&b.close()});e.on(k,"online",function(){var c,b;for(c=
0;c<v.length;c++)b=v[c],"waiting"===b.state()&&b.open()});e.on(k,"offline",function(){var c,b;for(c=0;c<v.length;c++)b=v[c],"opened"===b.state()&&b.fire("close","error")});return C});