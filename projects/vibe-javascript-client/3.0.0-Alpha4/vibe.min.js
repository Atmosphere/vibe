/* Vibe v3.0.0-Alpha4 | http://vibe-project.github.io/projects/vibe-javascript-client/ | (c) 2014, The Vibe Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(f,s){if("function"===typeof define&&define.amd)define([],function(){return s(f)});else if("object"===typeof exports){var v=require("jsdom").jsdom().parentWindow;v.WebSocket=require("ws");v.EventSource=require("eventsource");module.exports=s(v);module.exports.util.corsable=!0}else f.vibe=s(f)})(this,function(f){function s(c){var b,a,d,e,g,l,m=[],q=function(q,p){p=p||[];a=!c||[q,p];d=!0;l=e||0;e=0;for(g=m.length;l<g&&!b;l++)m[l].apply(q,p);d=!1};return{add:function(c){var l=m.length;m.push(c);
d?g=m.length:!b&&a&&!0!==a&&(e=l,q(a[0],a[1]))},remove:function(b){var a;for(a=0;a<m.length;a++)if(b===m[a]||b.guid&&b.guid===m[a].guid)d&&a<=g&&(g--,a<=l&&l--),m.splice(a--,1)},fire:function(e,l){b||d||c&&a||q(e,l)},lock:function(){b=!0},locked:function(){return!!b},unlock:function(){b=a=d=e=g=l=void 0}}}function v(c,b){var a={reconnect:function(a){return 2*(a||250)},timeout:!1,transports:["ws","stream","longpoll"],xdrURL:null};if(b)for(var d in b)a[d]=b[d];b=a;b.url=h.makeAbsolute(c);a=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(b.url.toLowerCase());
b.crossOrigin=!(!a||a[1]==w.protocol&&a[2]==w.hostname&&(a[3]||("http:"===a[1]?80:443))==(w.port||("http:"===w.protocol?80:443)));var e={},g={};e.on=function(a,b){var c;c=g[a];if(!c){if(g.message.locked())return this;c=g[a]=s();c.order=g.message.order}c.add(b);return this};e.off=function(a,b){var c=g[a];c&&c.remove(b);return this};e.once=function(a,b){function c(){e.off(a,c);b.apply(e,arguments)}b.guid=b.guid||u++;c.guid=b.guid;return e.on(a,c)};e.fire=function(a){var b=g[a];b&&b.fire(e,A.call(arguments,
1));return this};var l;e.state=function(){return l};for(d in{connecting:1,open:1,close:1,waiting:1})g[d]=s(!0),g[d].order=u++;g.message=s(!1);g.message.order=g.open.order;e.on("connecting",function(){function a(){clearTimeout(c)}l="connecting";var c;0<b.timeout&&(c=setTimeout(function(){e.fire("error",Error("timeout"));m.close()},b.timeout),e.once("open",a).once("close",a))}).on("open",function(){function a(){c=setTimeout(function(){e.send("heartbeat").once("heartbeat",function(){clearTimeout(c);
a()});c=setTimeout(function(){e.fire("error",Error("heartbeat"));m.close()},b._heartbeat)},b.heartbeat-b._heartbeat)}l="opened";var c;b.heartbeat>b._heartbeat&&(a(),e.once("close",function(){clearTimeout(c)}));g.connecting.lock();q=f=p=null}).on("close",function(){l="closed";var a,c,d=g.close.order;for(a in g)c=g[a],c.order<d&&c.lock();if(b.reconnect)e.once("close",function(){p=p||1;f=b.reconnect.call(e,f,p);!1!==f&&(q=setTimeout(function(){e.open()},f),e.fire("waiting",f,p))})}).on("waiting",function(){l=
"waiting"});var m,q,f,p;e.open=function(){var a;clearTimeout(q);for(a in g)g[a].unlock();m=null;l="preparing";p&&p++;for(var c=A.call(b.transports);!m&&c.length;)a=c.shift(),m=n[a](e,b);m?(b.transport=a,e.fire("connecting"),m.open()):e.fire("error",Error("notransport")).fire("close");return this};e.close=function(){b.reconnect=!1;clearTimeout(q);m&&m.close();return this};var z={};e.send=function(a,c,b,d){"opened"!==l&&e.fire(Error("notopened"));a={id:u++,type:a,data:c,reply:!(!b&&!d)};a.reply&&(z[a.id]=
[b,d]);m.send(h.stringifyJSON(a));return this};e.receive=function(a){if("connecting"===l)return a=h.parseURI(a).query,b.heartbeat=+a.heartbeat,a._heartbeat&&(b._heartbeat=+a._heartbeat),e.fire("open");var c=h.parseJSON(a),d;a=function(a){return function(b){d||(d=!0,e.send("reply",{id:c.id,data:b,exception:!a}))}};a=[c.type,c.data,c.reply?{resolve:a(!0),reject:a(!1)}:null];return e.fire.apply(e,a)};e.on("reply",function(a){z[a.id][+a.exception].call(e,a.data);delete z[a.id]});return e.open()}var u=
1,A=Array.prototype.slice,C=Object.prototype.toString,D=Object.prototype.hasOwnProperty,r=f.document,w=f.location,E=f.navigator,x=r.head||r.getElementsByTagName("head")[0]||r.documentElement,h={makeAbsolute:function(c){var b=r.createElement("div");b.innerHTML='<a href="'+c+'"/>';return encodeURI(decodeURI(b.firstChild.href))},on:function(c,b,a){c.addEventListener?c.addEventListener(b,a,!1):c.attachEvent&&c.attachEvent("on"+b,a)},off:function(c,b,a){c.removeEventListener?c.removeEventListener(b,a,
!1):c.detachEvent&&c.detachEvent("on"+b,a)},stringifyURI:function(c,b){var a,d=[];b=b||{};b._=u++;for(a in b)null!=b[a]&&d.push(encodeURIComponent(a)+"="+encodeURIComponent(b[a]));return c+(/\?/.test(c)?"&":"?")+d.join("&").replace(/%20/g,"+")},parseURI:function(c){var b={query:{}};if(c=/.*\?([^#]*)/.exec(c)){c=c[1].split("&");for(var a=0;a<c.length;a++){var d=c[a].split("=");b.query[decodeURIComponent(d[0])]=decodeURIComponent(d[1]||"")}}return b},xhr:function(){try{return new f.XMLHttpRequest}catch(c){try{return new f.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}},
parseJSON:f.JSON?f.JSON.parse:function(c){return Function("return "+c)()},stringifyJSON:f.JSON?f.JSON.stringify:function(c){function b(a){return'"'+a.replace(d,function(a){var c=e[a];return"string"===typeof c?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function a(a){return 10>a?"0"+a:a}var d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',
"\\":"\\\\"};return function l(c,d){var e,h,f,k=d[c];f=typeof k;k&&"object"===typeof k&&"function"===typeof k.toJSON&&(k=k.toJSON(c),f=typeof k);switch(f){case "string":return b(k);case "number":return isFinite(k)?String(k):"null";case "boolean":return String(k);case "object":if(!k)return"null";switch(C.call(k)){case "[object Date]":return isFinite(k.valueOf())?'"'+k.getUTCFullYear()+"-"+a(k.getUTCMonth()+1)+"-"+a(k.getUTCDate())+"T"+a(k.getUTCHours())+":"+a(k.getUTCMinutes())+":"+a(k.getUTCSeconds())+
'Z"':"null";case "[object Array]":h=k.length;f=[];for(e=0;e<h;e++)f.push(l(e,k)||"null");return"["+f.join(",")+"]";default:f=[];for(e in k)D.call(k,e)&&(h=l(e,k))&&f.push(b(e)+":"+h);return"{"+f.join(",")+"}"}}}("",{"":c})}};h.corsable="withCredentials"in h.xhr();h.browser=function(){var c=E.userAgent.toLowerCase(),b={},c=/(msie) ([\w.]+)/.exec(c)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(c)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(c)||0>c.indexOf("android")&&/version\/(.+) (safari)/.exec(c)||[];"safari"===
c[2]&&(c[2]=c[1],c[1]="safari");b[c[1]||""]=!0;b.version=c[2]||"0";b.vmajor=b.version.split(".")[0];b.trident&&(b.msie=!0);return b}();var n={ws:function(c,b){var a=f.WebSocket;if(a){var d;return{open:function(){var e=b.url.replace(/^http/,"ws");d=new a(e);d.onmessage=function(a){c.receive(a.data)};d.onerror=function(){c.fire("error",Error()).fire("close")};d.onclose=function(){c.fire("close")}},send:function(a){d.send(a)},close:function(){d.close()}}}},httpbase:function(c,b){function a(a){"opened"===
c.state()&&d.send(a)}var d={uri:{open:function(){return h.stringifyURI(b.url,{id:d.id,when:"open",transport:b.transport})},send:function(){return h.stringifyURI(b.url,{id:d.id})}}},e=c.receive;c.receive=function(a){var b=h.parseURI(a).query;d.id=b.id;e.apply(c,arguments);c.receive=e;return c};d.send=!b.crossOrigin||h.corsable?function(c){var b=h.xhr();b.onreadystatechange=function(){4===b.readyState&&200!==b.status&&a(c)};b.open("POST",d.uri.send());b.setRequestHeader("content-type","text/plain; charset=UTF-8");
h.corsable&&(b.withCredentials=!0);b.send("data="+c)}:f.XDomainRequest&&b.xdrURL?function(e){var g=new f.XDomainRequest;g.onerror=function(){a(e)};g.open("POST",b.xdrURL.call(c,d.uri.send()));g.send("data="+e)}:function(c){var b,e=r.createElement("form");e.action=d.uri.send();e.target="socket-"+u++;e.method="POST";e.enctype=e.encoding="text/plain";e.acceptCharset="UTF-8";e.style.display="none";e.innerHTML='<textarea name="data"></textarea><iframe name="'+e.target+'"></iframe>';e.firstChild.value=
c;b=e.lastChild;h.on(b,"error",function(){a(c)});h.on(b,"load",function(){r.body.removeChild(e)});r.body.appendChild(e);e.submit()};var g;d.close=function(){d.abort();if(!g){g=!0;var a=r.createElement("script");a.async=!1;a.src=h.stringifyURI(b.url,{id:d.id,when:"abort"});a.onload=a.onerror=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),c.fire("close")};x.insertBefore(a,x.firstChild)}};
return d},stream:function(c,b){return n.sse(c,b)||n.streamxhr(c,b)||n.streamxdr(c,b)||n.streamiframe(c,b)},sse:function(c,b){var a=f.EventSource;if(a&&!(b.crossOrigin&&h.browser.safari&&7>h.browser.vmajor)){var d,e=n.httpbase(c,b);e.open=function(){d=new a(e.uri.open()+"&sse=true",{withCredentials:!0});d.onmessage=function(a){c.receive(a.data)};d.onerror=function(){d.close();c.fire("close")}};e.abort=function(){d.close()};return e}},streambase:function(c,b){var a="",d=n.httpbase(c,b);d.parse=function(b){if(b=
b.replace(/^\s+/,"")){b=(a+b).split("\n\n");for(var d=0;d<b.length-1;d++)c.receive(b[d].substring(6));a=b[b.length-1]}};return d},streamxhr:function(c,b){if(!(h.browser.msie&&10>h.browser.vmajor||h.browser.opera&&13>h.browser.vmajor||b.crossOrigin&&!h.corsable)){var a,d=n.streambase(c,b);d.open=function(){var b;a=h.xhr();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(d.parse(b?a.responseText.substring(b):a.responseText),b=a.responseText.length):4===a.readyState&&(200!==a.status&&
c.fire("error",Error()),c.fire("close"))};a.open("GET",d.uri.open());h.corsable&&(a.withCredentials=!0);a.send()};d.abort=function(){a.abort()};return d}},streamxdr:function(c,b){var a=f.XDomainRequest;if(a&&b.xdrURL){var d,e=n.streambase(c,b);e.open=function(){var g;d=new a;d.onprogress=function(){e.parse(g?d.responseText.substring(g):d.responseText);g=d.responseText.length};d.onerror=function(){c.fire("error",Error()).fire("close")};d.onload=function(){c.fire("close")};d.open("GET",b.xdrURL.call(c,
e.uri.open()));d.send()};e.abort=function(){d.abort()};return e}},streamiframe:function(c,b){var a=f.ActiveXObject;if(a&&!b.crossOrigin){var d,e,g=n.streambase(c,b);g.open=function(){function b(a){var c;(function k(){c=setTimeout(function(){!1!==a()&&k()},1)})();return function(){clearTimeout(c)}}d=new a("htmlfile");d.open();d.close();var f=d.createElement("iframe");f.src=g.uri.open();d.body.appendChild(f);var h=f.contentDocument||f.contentWindow.document;e=b(function(){function a(){var b=d.cloneNode(!0);
b.appendChild(h.createTextNode("."));b=b.innerText.replace(/\r\n/g,"\n");return b.substring(0,b.length-1)}if(h.firstChild){var d=h.body.lastChild;if(!d)return c.fire("error",Error()).fire("close"),!1;g.parse(a());d.innerText="";e=b(function(){var b=a();b&&(d.innerText="",g.parse(b));if("complete"===h.readyState)return c.fire("close"),!1});return!1}})};g.abort=function(){e();d.execCommand("Stop")};return g}},longpoll:function(c,b){return n.longpollajax(c,b)||n.longpollxdr(c,b)||n.longpolljsonp(c,b)},
longpollbase:function(c,b){var a=n.httpbase(c,b);a.open=function(){a.connect(a.uri.open(),function(d){var e=/(\d+)\|(.*)/;d=e.exec(d);c.receive(d[2]);(function l(d){a.connect(h.stringifyURI(b.url,{id:a.id,when:"poll",lastMsgId:d}),function(a){a?(a=e.exec(a),l(a[1]),c.receive(a[2])):c.fire("close")})})(d[1])})};return a},longpollajax:function(c,b){if(!b.crossOrigin||h.corsable){var a,d=n.longpollbase(c,b);d.connect=function(b,d){a=h.xhr();a.onreadystatechange=function(){4===a.readyState&&(200===a.status?
d(a.responseText):c.fire("error",Error()))};a.open("GET",b);h.corsable&&(a.withCredentials=!0);a.send(null)};d.abort=function(){a.abort()};return d}},longpollxdr:function(c,b){var a=f.XDomainRequest;if(a&&b.xdrURL){var d,e=n.longpollbase(c,b);e.connect=function(e,f){e=b.xdrURL.call(c,e);d=new a;d.onload=function(){f(d.responseText)};d.onerror=function(){c.fire("error",Error()).fire("close")};d.open("GET",e);d.send()};e.abort=function(){d.abort()};return e}}},B=[];n.longpolljsonp=function(c,b){var a,
d=n.longpollbase(c,b),e=B.pop()||"socket_"+u++;f[e]=function(b){a.responseText=b};c.once("close",function(){f[e]=function(){};B.push(e)});var g=d.uri.open;d.uri.open=function(){return g.apply(d,arguments)+"&jsonp=true&callback="+e};d.connect=function(b,d){a=r.createElement("script");a.async=!0;a.src=b;a.clean=function(){a.clean=a.onerror=a.onload=a.onreadystatechange=a.responseText=null;a.parentNode&&a.parentNode.removeChild(a)};a.onload=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.clean&&
a.clean(),d(a.responseText)};a.onerror=function(){a.clean();c.fire("error",Error()).fire("close")};x.insertBefore(a,x.firstChild)};d.abort=function(){a.clean&&a.clean()};return d};var y={},t=[];y.open=function(c,b){var a=v(c,b);t.push(a);return a};y.util=h;y.transports=n;h.on(f,"unload",function(){for(var c,b=0;b<t.length;b++)c=t[b],"closed"!==c.state()&&c.close()});h.on(f,"online",function(){for(var c,b=0;b<t.length;b++)c=t[b],"waiting"===c.state()&&c.open()});h.on(f,"offline",function(){for(var c,
b=0;b<t.length;b++)c=t[b],"opened"===c.state()&&c.fire("error",Error()).fire("close")});return y});