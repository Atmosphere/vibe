/* Vibe v3.0.0-Alpha1 | http://atmosphere.github.io/vibe/ | (c) 2011-2014, Donghwan Kim | http://www.apache.org/licenses/LICENSE-2.0 */
(function(g,t){if("function"===typeof define&&define.amd)define([],function(){return t(g)});else if("object"===typeof exports){var x=require("jsdom").jsdom().createWindow();x.WebSocket=require("ws");x.EventSource=require("eventsource");module.exports=t(x);module.exports.util.corsable=!0}else g.vibe=t(g)})(this,function(g){function t(c){var b,a,h,f,d,e,m=[],g=function(g,r){r=r||[];a=!c||[g,r];h=!0;e=f||0;f=0;for(d=m.length;e<d&&!b;e++)m[e].apply(g,r);h=!1};return{add:function(c){var e=m.length;m.push(c);
h?d=m.length:!b&&a&&!0!==a&&(f=e,g(a[0],a[1]))},remove:function(a){var b;for(b=0;b<m.length;b++)if(a===m[b]||a.guid&&a.guid===m[b].guid)h&&b<=d&&(d--,b<=e&&e--),m.splice(b--,1)},fire:function(d,f){b||h||c&&a||g(d,f)},lock:function(){b=!0},locked:function(){return!!b},unlock:function(){b=a=h=f=d=e=void 0}}}function x(c,b){c=e.makeAbsolute(c);var a,h=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(c.toLowerCase()),f={transports:["ws","stream","longpoll"],timeout:!1,heartbeat:2E4,_heartbeat:5E3,
sharing:!1,reconnect:function(a){return 2*(a||250)},xdrURL:null};if(b)for(a in b)f[a]=b[a];b=f;b.url=c;b.id="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"===a?b:b&3|8).toString(16)});b.crossOrigin=!(!h||h[1]==z.protocol&&h[2]==z.hostname&&(h[3]||("http:"===h[1]?80:443))==(z.port||("http:"===z.protocol?80:443)));var d={},k={};d.on=function(a,b){var c;c=k[a];if(!c){if(k.message.locked())return this;c=k[a]=t();c.order=k.message.order}c.add(b);return this};
d.off=function(a,b){var c=k[a];c&&c.remove(b);return this};d.once=function(a,b){function c(){d.off(a,c);b.apply(d,arguments)}b.guid=b.guid||v++;c.guid=b.guid;return d.on(a,c)};d.fire=function(a){var b=k[a];b&&b.fire(d,E.call(arguments,1));return this};var m;d.state=function(){return m};for(a in{connecting:1,open:1,close:1,waiting:1})k[a]=t(!0),k[a].order=v++;k.message=t(!1);k.message.order=k.open.order;d.on("connecting",function(){function a(){clearTimeout(h)}function f(){function a(b){b=e.parseJSON(b);
if("p"===b.target)switch(b.type){case "send":b=e.parseJSON(b.data);d.send(b.type,b.data,b.onResolved,b.onRejected);break;case "close":d.close()}}function h(a){s.broadcast({target:"c",type:"message",data:a})}function l(){n.cookie=encodeURIComponent(k)+"="+encodeURIComponent(e.stringifyJSON({ts:e.now(),heir:(s.get("children")||[])[0]}))+"; path=/"}var r,s,k="socket-"+c,m={storage:function(){var b=g.localStorage;if(!e.browser.msie)return{init:function(){function c(b){b.key===k&&b.newValue&&a(b.newValue)}
e.on(g,"storage",c);d.once("close",function(){e.off(g,"storage",c);d.once("close",function(){b.removeItem(k);b.removeItem(k+"-opened");b.removeItem(k+"-children")})})},broadcast:function(c){var d=e.stringifyJSON(c);b.setItem(k,d);setTimeout(function(){a(d)},50)},get:function(a){return e.parseJSON(b.getItem(k+"-"+a))},set:function(a,c){b.setItem(k+"-"+a,e.stringifyJSON(c))}}},windowref:function(){var b=k.replace(/\W/g,""),c=n.getElementById(b),d;c||(c=n.createElement("div"),c.id=b,c.style.display=
"none",c.innerHTML='<iframe name="'+b+'" />',n.body.appendChild(c));d=c.firstChild.contentWindow;return{init:function(){d.callbacks=[a];d.fire=function(b){var a;for(a=0;a<d.callbacks.length;a++)d.callbacks[a](b)}},broadcast:function(b){!d.closed&&d.fire&&d.fire(e.stringifyJSON(b))},get:function(b){return d.closed?null:d[b]},set:function(b,a){d.closed||(d[b]=a)}}}};s=m.storage()||m.windowref();s.init();s.set("children",[]);s.set("opened",!1);l();r=setInterval(l,1E3);d.on("_message",h).once("open",
function(){s.set("opened",!0);s.broadcast({target:"c",type:"open"})}).once("close",function(a){clearInterval(r);n.cookie=encodeURIComponent(k)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";s.broadcast({target:"c",type:"close",data:{reason:a,heir:A?(s.get("children")||[])[0]:b.id}});d.off("_message",h)})}m="connecting";var h;0<b.timeout&&(h=setTimeout(function(){d.fire("close","timeout");p.close()},b.timeout),d.once("open",a).once("close",a));b.sharing&&!y&&f()}).on("open",function(){function a(){c=
setTimeout(function(){d.send("heartbeat").once("heartbeat",function(){clearTimeout(c);a()});c=setTimeout(function(){d.fire("close","error");p.close()},b._heartbeat)},b.heartbeat-b._heartbeat)}m="opened";var c;b.heartbeat>b._heartbeat&&(a(),d.once("close",function(){clearTimeout(c)}));k.connecting.lock();r=w=l=null}).on("close",function(){m="closed";var a,c,f=k.close.order;for(a in k)c=k[a],c.order<f&&c.lock();if(b.reconnect)d.once("close",function(){l=l||1;w=b.reconnect.call(d,w,l);!1!==w&&(r=setTimeout(function(){d.open()},
w),d.fire("waiting",w,l))})}).on("waiting",function(){m="waiting"});var p,y,r,w,l;d.open=function(){var a,c;clearTimeout(r);for(a in k)k[a].unlock();p=y=null;m="preparing";c=E.call(b.transports);for(b.sharing&&c.unshift("session");!p&&c.length;)switch(a=c.shift(),a){case "stream":c.unshift("sse","streamxhr","streamxdr","streamiframe");break;case "longpoll":c.unshift("longpollajax","longpollxdr","longpolljsonp");break;default:p=q[a](d,b)}l&&l++;p?(b.transport=a,y="session"===a,d.fire("connecting"),
p.open()):d.fire("close","notransport");return this};d.close=function(){b.reconnect=!1;clearTimeout(r);d.fire("close",A?"error":"aborted");p&&p.close();return this};var C={};d.send=function(a,b,c,d){if("opened"!==m)throw Error("A socket is not open yet");a={id:v++,type:a,data:b,reply:!(!c&&!d)};a.reply&&(y?(a.onResolved=c,a.onRejected=d):C[a.id]=[c,d]);p.send(e.stringifyJSON(a));return this};d.receive=function(a){var b,c=e.parseJSON(a);a=[c.type,c.data,c.reply?{resolve:function(a){b||(b=!0,d.send("reply",
{id:c.id,data:a,exception:!1}))},reject:function(a){b||(b=!0,d.send("reply",{id:c.id,data:a,exception:!0}))}}:null];return d.fire.apply(d,a).fire("_message",a)};d.on("reply",function(a){var b=a.id,c=a.data,f=C[b];f&&((a=f[+a.exception])&&(e.isFunction(a)?a.call(d,c):d.fire(a,c).fire("_message",[a,c])),delete C[b])});return d.open()}var v=1,A,E=Array.prototype.slice,D=Object.prototype.toString,G=Object.prototype.hasOwnProperty,n=g.document,z=g.location,H=g.navigator,e;e={now:Date.now||function(){return+new Date},
isArray:Array.isArray||function(c){return"[object Array]"===D.call(c)},isFunction:function(c){return"[object Function]"===D.call(c)},makeAbsolute:function(c){var b=n.createElement("div");b.innerHTML='<a href="'+c+'"/>';return encodeURI(decodeURI(b.firstChild.href))},on:function(c,b,a){c.addEventListener?c.addEventListener(b,a,!1):c.attachEvent&&c.attachEvent("on"+b,a)},off:function(c,b,a){c.removeEventListener?c.removeEventListener(b,a,!1):c.detachEvent&&c.detachEvent("on"+b,a)},url:function(c,b){var a,
h=[];b=b||{};b._=v++;for(a in b)h.push(encodeURIComponent(a)+"="+encodeURIComponent(b[a]));return c+(/\?/.test(c)?"&":"?")+h.join("&").replace(/%20/g,"+")},xhr:function(){try{return new g.XMLHttpRequest}catch(c){try{return new g.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}},parseJSON:g.JSON?g.JSON.parse:function(c){return Function("return "+c)()},stringifyJSON:g.JSON?g.JSON.stringify:function(c){function b(a){return'"'+a.replace(h,function(a){var b=f[a];return"string"===typeof b?b:"\\u"+("0000"+
a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function a(a){return 10>a?"0"+a:a}var h=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,f={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function k(c,f){var h,e,g,l=f[c];g=typeof l;l&&"object"===typeof l&&"function"===typeof l.toJSON&&(l=l.toJSON(c),g=typeof l);switch(g){case "string":return b(l);case "number":return isFinite(l)?String(l):
"null";case "boolean":return String(l);case "object":if(!l)return"null";switch(D.call(l)){case "[object Date]":return isFinite(l.valueOf())?'"'+l.getUTCFullYear()+"-"+a(l.getUTCMonth()+1)+"-"+a(l.getUTCDate())+"T"+a(l.getUTCHours())+":"+a(l.getUTCMinutes())+":"+a(l.getUTCSeconds())+'Z"':"null";case "[object Array]":e=l.length;g=[];for(h=0;h<e;h++)g.push(k(h,l)||"null");return"["+g.join(",")+"]";default:g=[];for(h in l)G.call(l,h)&&(e=k(h,l))&&g.push(b(h)+":"+e);return"{"+g.join(",")+"}"}}}("",{"":c})}};
e.corsable="withCredentials"in e.xhr();e.browser=function(){var c=H.userAgent.toLowerCase(),b={},c=/(msie) ([\w.]+)/.exec(c)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(c)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(c)||0>c.indexOf("android")&&/version\/(.+) (safari)/.exec(c)||[];b[c[1]||""]=!0;b.version=c[2]||"0";b.vmajor=b.version.split(".")[0];b.trident&&(b.msie=!0);return b}();var q,F=[];q={session:function(c,b){function a(a,b){var c,d=a.length;for(c=0;c<d;c++)a[c]===b&&a.splice(c,1);return d!==a.length}
function h(a){a=e.parseJSON(a);var d=a.data;if("c"===a.target)switch(a.type){case "open":c.fire("open");break;case "close":k||(k=!0,"aborted"===d.reason?c.close():d.heir===b.id?c.fire("close",d.reason):setTimeout(function(){c.fire("close",d.reason)},100));break;case "message":if("connecting"===c.state())c.once("open",function(){c.fire.apply(c,d)});else c.fire.apply(c,d)}}function f(){var a=(new RegExp("(?:^|; )("+encodeURIComponent(p)+")=([^;]*)")).exec(n.cookie);if(a)return e.parseJSON(decodeURIComponent(a[2]))}
var d,k,m,p="socket-"+b.url,q={storage:function(){function d(a){return e.parseJSON(k.getItem(p+"-"+a))}function f(a,b){k.setItem(p+"-"+a,e.stringifyJSON(b))}if(!e.browser.msie){var k=g.localStorage;return{init:function(){function k(a){a.key===p&&a.newValue&&h(a.newValue)}f("children",d("children").concat([b.id]));e.on(g,"storage",k);c.once("close",function(){var c=d("children");e.off(g,"storage",k);c&&a(c,b.id)&&f("children",c)});return d("opened")},broadcast:function(a){var b=e.stringifyJSON(a);
k.setItem(p,b);setTimeout(function(){h(b)},50)}}}},windowref:function(){var d=g.open("",p.replace(/\W/g,""));if(d&&!d.closed&&d.callbacks)return{init:function(){d.callbacks.push(h);d.children.push(b.id);c.once("close",function(){k||(a(d.callbacks,h),a(d.children,b.id))});return d.opened},broadcast:function(a){!d.closed&&d.fire&&d.fire(e.stringifyJSON(a))}}}};if((d=f())&&!(1E3<e.now()-d.ts)&&(m=q.storage()||q.windowref()))return{open:function(){var a,k=b.timeout,g=b.heartbeat;b.timeout=b.heartbeat=
!1;a=setInterval(function(){var a=d;(d=f())&&a.ts!==d.ts||h(e.stringifyJSON({target:"c",type:"close",data:{reason:"error",heir:a.heir}}))},1E3);c.once("close",function(){clearInterval(a);b.timeout=k;b.heartbeat=g});m.init()&&setTimeout(function(){c.fire("open")},50)},send:function(a){m.broadcast({target:"p",type:"send",data:a})},close:function(){A||m.broadcast({target:"p",type:"close"})}}},base:function(c,b){return{uri:{open:function(){return e.url(b.url,{id:b.id,when:"open",transport:b.transport,
heartbeat:b.heartbeat})}}}},ws:function(c,b){var a,h=g.WebSocket,f=q.base(c,b);if(h)return f.open=function(){var b=f.uri.open().replace(/^http/,"ws");a=new h(b);a.onopen=function(){c.fire("open")};a.onmessage=function(a){c.receive(a.data)};a.onerror=function(){c.fire("close","error")};a.onclose=function(a){c.fire("close",a.wasClean?"done":"error")}},f.send=function(b){a.send(b)},f.close=function(){a.close()},f},httpbase:function(c,b){var a=q.base(c,b);a.send=!b.crossOrigin||e.corsable?function(a){var c=
e.xhr();c.open("POST",e.url(b.url,{id:b.id}));c.setRequestHeader("content-type","text/plain; charset=UTF-8");e.corsable&&(c.withCredentials=!0);c.send("data="+a)}:g.XDomainRequest&&b.xdrURL?function(a){var f=new g.XDomainRequest;f.open("POST",b.xdrURL.call(c,e.url(b.url,{id:b.id})));f.send("data="+a)}:function(a){var c=n.createElement("form");c.action=e.url(b.url,{id:b.id});c.target="socket-"+v++;c.method="POST";c.enctype=c.encoding="text/plain";c.acceptCharset="UTF-8";c.style.display="none";c.innerHTML=
'<textarea name="data"></textarea><iframe name="'+c.target+'"></iframe>';c.firstChild.value=a;e.on(c.lastChild,"load",function(){n.body.removeChild(c)});n.body.appendChild(c);c.submit()};a.close=function(){a.abort();var c=n.createElement("script"),f=n.head||n.getElementsByTagName("head")[0]||n.documentElement;c.async=!1;c.src=e.url(b.url,{id:b.id,when:"abort"});c.onload=c.onreadystatechange=function(){if(!c.readyState||/loaded|complete/.test(c.readyState))c.onload=c.onreadystatechange=null,c.parentNode&&
c.parentNode.removeChild(c)};f.insertBefore(c,f.firstChild)};return a},sse:function(c,b){var a,h=g.EventSource,f=q.httpbase(c,b);if(h&&!(b.crossOrigin&&e.browser.safari&&7>e.browser.vmajor))return f.open=function(){var b=f.uri.open();a=new h(b,{withCredentials:!0});a.onopen=function(){c.fire("open")};a.onmessage=function(a){c.receive(a.data)};a.onerror=function(){a.close();c.fire("close","done")}},f.abort=function(){a.close()},f},streambase:function(c,b){var a="",h=q.httpbase(c,b);h.parse=function(b){if(b=
b.replace(/^\s+/,"")){var d=(a+b).split("\n\n");for(b=0;b<d.length-1;b++)c.receive(d[b].substring(6));a=d[d.length-1]}};return h},streamxhr:function(c,b){var a,h=q.streambase(c,b);if(!(e.browser.msie&&10>e.browser.vmajor||e.browser.opera&&13>e.browser.vmajor||b.crossOrigin&&!e.corsable))return h.open=function(){var b,d,k=h.uri.open();a=e.xhr();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(d=a.responseText.length,b?d>b&&h.parse(a.responseText.substring(b)):(c.fire("open"),h.parse(a.responseText)),
b=d):4===a.readyState&&c.fire("close",200===a.status?"done":"error")};a.open("GET",k);e.corsable&&(a.withCredentials=!0);a.send(null)},h.abort=function(){a.abort()},h},streamxdr:function(c,b){var a,h=g.XDomainRequest,e=q.streambase(c,b);if(h&&b.xdrURL)return e.open=function(){var d,k,g=b.xdrURL.call(c,e.uri.open());a=new h;a.onprogress=function(){k=a.responseText.length;d?e.parse(a.responseText.substring(d)):(c.fire("open"),e.parse(a.responseText));d=k};a.onerror=function(){c.fire("close","error")};
a.onload=function(){c.fire("close","done")};a.open("GET",g);a.send()},e.abort=function(){a.abort()},e},streamiframe:function(c,b){var a,e,f=g.ActiveXObject,d=q.streambase(c,b);if(f&&!b.crossOrigin){try{new f("htmlfile")}catch(k){return}d.open=function(){function b(a){var c;(function s(){c=setTimeout(function(){!1!==a()&&s()},1)})();return function(){clearTimeout(c)}}var k,g,n=d.uri.open();a=new f("htmlfile");a.open();a.close();k=a.createElement("iframe");k.src=n;a.body.appendChild(k);g=k.contentDocument||
k.contentWindow.document;e=b(function(){function a(){var b;b=f.cloneNode(!0);b.appendChild(g.createTextNode("."));b=b.innerText.replace(/\r\n/g,"\n");return b.substring(0,b.length-1)}var f;if(g.firstChild){f=g.body.lastChild;if(!f)return c.fire("close","error"),!1;c.fire("open");d.parse(a());f.innerText="";e=b(function(){var b=a();b&&(f.innerText="",d.parse(b));if("complete"===g.readyState)return c.fire("close","done"),!1});return!1}})};d.abort=function(){e();a.execCommand("Stop")};return d}},longpollbase:function(c,
b){var a=q.httpbase(c,b);a.uri.poll=function(a){return e.url(b.url,{id:b.id,when:"poll",lastEventIds:a.join(",")})};a.open=function(){a.connect(a.uri.open(),function(){function b(f){a.connect(a.uri.poll(f),function(a){if(a){var f=[];a=e.parseJSON(a);var g=e.isArray(a)?a:[a];for(a=0;a<g.length;a++)f.push(g[a].id);b(f);for(a=0;a<g.length;a++)c.receive(e.stringifyJSON(g[a]))}else c.fire("close","done")})}b([]);c.fire("open")})};return a},longpollajax:function(c,b){var a,h=q.longpollbase(c,b);if(!b.crossOrigin||
e.corsable)return h.connect=function(b,d){a=e.xhr();a.onreadystatechange=function(){4===a.readyState&&(200===a.status?d(a.responseText):c.fire("close","error"))};a.open("GET",b);e.corsable&&(a.withCredentials=!0);a.send(null)},h.abort=function(){a.abort()},h},longpollxdr:function(c,b){var a,e=g.XDomainRequest,f=q.longpollbase(c,b);if(e&&b.xdrURL)return f.connect=function(d,f){d=b.xdrURL.call(c,d);a=new e;a.onload=function(){f(a.responseText)};a.onerror=function(){c.fire("close","error")};a.open("GET",
d);a.send()},f.abort=function(){a.abort()},f},longpolljsonp:function(c,b){var a,e=F.pop()||"socket_"+v++,f=q.longpollbase(c,b);g[e]=function(b){a.responseText=b};c.once("close",function(){g[e]=function(){};F.push(e)});f.uri._open=f.uri.open;f.uri.open=function(){return f.uri._open.apply(f,arguments)+"&callback="+e};f.connect=function(b,e){var f=n.head||n.getElementsByTagName("head")[0]||n.documentElement;a=n.createElement("script");a.async=!0;a.src=b;a.clean=function(){a.clean=a.onerror=a.onload=
a.onreadystatechange=null;a.parentNode&&a.parentNode.removeChild(a)};a.onload=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.clean&&a.clean(),e(a.responseText)};a.onerror=function(){a.clean();c.fire("close","error")};f.insertBefore(a,f.firstChild)};f.abort=function(){a.clean&&a.clean()};return f}};var B={},u=[];B.open=function(c,b){var a=x(c,b);u.push(a);return a};B.util=e;B.transports=q;e.on(g,"unload",function(){A=!0;var c,b;for(c=0;c<u.length;c++)b=u[c],
"closed"!==b.state()&&b.close()});e.on(g,"online",function(){var c,b;for(c=0;c<u.length;c++)b=u[c],"waiting"===b.state()&&b.open()});e.on(g,"offline",function(){var c,b;for(c=0;c<u.length;c++)b=u[c],"opened"===b.state()&&b.fire("close","error")});return B});