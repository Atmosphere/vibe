/* Vibe v3.0.0-Alpha13 | http://vibe-project.github.io/projects/vibe-javascript-client/ | (c) 2014, The Vibe Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(h,m){if("function"===typeof define&&define.amd)define([],function(){return m(h)});else if("object"===typeof exports){var v=require("jsdom").jsdom().parentWindow;v.WebSocket=require("ws");v.EventSource=require("eventsource");module.exports=m(v);module.exports.util.corsable=!0}else h.vibe=m(h)})(this,function(h){function m(b){var e,a,d,c,f,l,g=[],p=function(D,n){n=n||[];a=!b||[D,n];d=!0;l=c||0;c=0;for(f=g.length;l<f&&!e;l++)g[l].apply(D,n);d=!1};return{add:function(b){var l=g.length;g.push(b);
d?f=g.length:!e&&a&&!0!==a&&(c=l,p(a[0],a[1]))},remove:function(b){var a;for(a=0;a<g.length;a++)if(b===g[a]||b.guid&&b.guid===g[a].guid)d&&a<=f&&(f--,a<=l&&l--),g.splice(a--,1)},fire:function(c,f){e||d||b&&a||p(c,f)},lock:function(){e=!0},locked:function(){return!!e},unlock:function(){e=a=d=c=f=l=void 0}}}function v(b,e){var a={reconnect:function(a){return 2*(a||250)},transports:[E,F,G]};if(e)for(var d in e)a[d]=e[d];e=a;var c={},f={};c.on=function(a,b){var c;c=f[a];if(!c){if(f.message.locked())return this;
c=f[a]=m();c.order=f.message.order}c.add(b);return this};c.off=function(a,b){var c=f[a];c&&c.remove(b);return this};c.once=function(a,b){function f(){c.off(a,f);b.apply(c,arguments)}b.guid=b.guid||u++;f.guid=b.guid;return c.on(a,f)};c.fire=function(a){var b=f[a];b&&b.fire(c,A.call(arguments,1));return this};var l,r,p,h;c.open=function(){n="preparing";l=null;clearTimeout(r);h&&h++;for(var a in f)f[a].unlock();return c.fire("connecting")};c.close=function(){e.reconnect=!1;clearTimeout(r);l?l.close():
c.fire("close");return this};var n;c.state=function(){return n};for(d in{connecting:1,open:1,close:1,waiting:1})f[d]=m(!0),f[d].order=u++;f.message=m(!1);f.message.order=f.open.order;c.on("connecting",function(){n="connecting";for(var a=g.isArray(b)?A.call(b):[b],f=0;f<a.length;f++){var d=a[f]=g.makeAbsolute(a[f]);/^https?:/.test(d)&&!g.parseURI(d).query.transport&&a.splice(f,1,d.replace(/^http/,"ws"),g.stringifyURI(d,{transport:"stream"}),g.stringifyURI(d,{transport:"longpoll"}))}(function w(){function b(){d.off("close",
w).close()}var f=a.shift();if(f){for(var d,r=0;r<e.transports.length&&!(d=e.transports[r](f,e));r++);d?(c.once("close",b),d.open().on("close",w).on("text",function M(a){d.off("text",M);a=g.parseURI(a).query;e.heartbeat=+a.heartbeat;e._heartbeat=+a._heartbeat||5E3;l=d.off("close",w);var f;l.on("text",function(a){if(f){var b=g.parseJSON(a),d;a=function(a){return function(f){d||(d=!0,c.send("reply",{id:b.id,data:f,exception:!a}))}};a=[b.type,b.data,b.reply?{resolve:a(!0),reject:a(!1)}:null];c.fire.apply(c,
a)}else f=!0}).on("error",function(a){c.fire("error",a)}).on("close",function(){c.fire("close")});c.off("close",b).fire("open")})):w()}else c.fire("error",Error()).fire("close")})()}).on("open",function(){n="opened";var a;(function L(){a=setTimeout(function(){c.send("heartbeat").once("heartbeat",function(){clearTimeout(a);L()});a=setTimeout(function(){c.fire("error",Error("heartbeat"));l.close()},e._heartbeat)},e.heartbeat-e._heartbeat)})();c.once("close",function(){clearTimeout(a)});f.connecting.lock();
r=p=h=null}).on("close",function(){n="closed";for(var a in f){var b=f[a];b.order<f.close.order&&b.lock()}if(e.reconnect)c.once("close",function(){h=h||1;p=e.reconnect.call(c,p,h);!1!==p&&(r=setTimeout(function(){c.open()},p),c.fire("waiting",p,h))})}).on("waiting",function(){n="waiting"});var B={};c.send=function(a,b,f,d){if("opened"!==n)return c.fire(Error("notopened")),this;a={id:u++,type:a,data:b,reply:!(!f&&!d)};a.reply&&(B[a.id]=[f,d]);l.send(g.stringifyJSON(a));return this};c.on("reply",function(a){B[a.id][+a.exception].call(c,
a.data);delete B[a.id]});return c.open()}function H(b,e){var a=e&&e.timeout||3E3,d={open:function(){function b(){clearTimeout(c)}d.connect();var c=setTimeout(function(){d.fire("error",Error("timeout")).close()},a);d.on("open",b).on("close",b);return this}},c={open:m(!0),text:m(),binary:m(),error:m(),close:m(!0)};d.on=function(a,b){c[a].add(b);return this};d.off=function(a,b){c[a].remove(b);return this};d.fire=function(a){c[a].fire(d,A.call(arguments,1));return this};d.on("close",function(){for(var a in c)"close"!==
a&&c[a].lock()});return d}function E(b,e){var a=h.WebSocket;if(a&&/^wss?:/.test(b)){var d,c=H(b,e);c.connect=function(){d=new a(b);d.binaryType="arraybuffer";d.onopen=function(){c.fire("open")};d.onmessage=function(a){"string"===typeof a.data?c.fire("text",a.data):c.fire("binary",a.data)};d.onerror=function(){c.fire("error",Error()).fire("close")};d.onclose=function(){c.fire("close")}};c.send=function(a){d.send(a);return this};c.close=function(){d.close();return this};return c}}function I(b,e){var a=
e&&e.xdrURL,d=H(b,e),c;d.on("open",function(){c=g.stringifyURI(b,{id:d.id})}).on("close",function(){c=null});d.send=!g.crossOrigin(b)||g.corsable?function(a){var b=g.createXMLHttpRequest();b.onreadystatechange=function(){4===b.readyState&&200!==b.status&&c&&d.send(a)};b.open("POST",c);g.corsable&&(b.withCredentials=!0);"string"===typeof a?(b.setRequestHeader("Content-Type","text/plain; charset=UTF-8"),b.send("data="+a)):(b.setRequestHeader("Content-Type","application/octet-stream"),b.send(a));return this}:
h.XDomainRequest&&a?function(b){var f=new h.XDomainRequest;f.onerror=function(){c&&d.send(b)};f.open("POST",a.call(d,c));f.send("data="+b);return this}:function(a){var b,f=q.createElement("form");f.action=c;f.target="socket-"+u++;f.method="POST";f.enctype=f.encoding="text/plain";f.acceptCharset="UTF-8";f.style.display="none";f.innerHTML='<textarea name="data"></textarea><iframe name="'+f.target+'"></iframe>';f.firstChild.value=a;b=f.lastChild;g.on(b,"error",function(){c&&d.send(a)});g.on(b,"load",
function(){q.body.removeChild(f)});q.body.appendChild(f);f.submit();return this};var f;d.close=function(){d.abort();if(!f){f=!0;var a=q.createElement("script");a.async=!1;a.src=g.stringifyURI(b,{id:d.id,when:"abort"});a.onload=a.onerror=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.onload=a.onreadystatechange=null,a.parentNode&&a.parentNode.removeChild(a),d.fire("close")};x.insertBefore(a,x.firstChild)}return this};return d}function F(b,e){if(/^https?:/.test(b)&&
"stream"===g.parseURI(b).query.transport)return N(b,e)||O(b,e)||P(b,e)||Q(b,e)}function y(b,e){var a="",d=I(b,e);d.parse=function(b){if(b=b.replace(/^\s+/,"")){b=(a+b).split("\n\n");for(var c=0;c<b.length-1;c++)d.onmessage(b[c].substring(6));a=b[b.length-1]}};var c;d.onmessage=function(a){if(c){var b=a.substring(0,1);a=a.substring(1);switch(b){case "1":d.fire("text",a);break;case "2":if("object"===typeof exports)a=new Buffer(a,"base64");else{b=atob(a);a=new Uint8Array(a.length);for(var e=0;e<b.length;e++)a[e]=
b.charCodeAt(e);a=a.buffer}d.fire("binary",a)}}else c=!0,b=g.parseURI(a).query,d.id=b.id,d.fire("open")};return d}function N(b,e){var a=h.EventSource;if(a&&!(g.crossOrigin(b)&&g.browser.safari&&7>g.browser.vmajor)){var d,c=y(b,e);c.connect=function(){d=new a(b+"&when=open&sse=true",{withCredentials:!0});d.onmessage=function(a){c.onmessage(a.data)};d.onerror=function(){d.close();c.fire("close")}};c.abort=function(){d.close()};return c}}function O(b,e){if(!(g.browser.msie&&10>g.browser.vmajor||g.crossOrigin(b)&&
!g.corsable)){var a,d=y(b,e);d.connect=function(){var c;a=g.createXMLHttpRequest();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(d.parse(c?a.responseText.substring(c):a.responseText),c=a.responseText.length):4===a.readyState&&(200!==a.status&&d.fire("error",Error()),d.fire("close"))};a.open("GET",b+"&when=open");g.corsable&&(a.withCredentials=!0);a.send()};d.abort=function(){a.abort()};return d}}function P(b,e){var a=e&&e.xdrURL,d=h.XDomainRequest;if(a&&d){var c,f=y(b,e);f.connect=
function(){var e;c=new d;c.onprogress=function(){f.parse(e?c.responseText.substring(e):c.responseText);e=c.responseText.length};c.onerror=function(){f.fire("error",Error()).fire("close")};c.onload=function(){f.fire("close")};c.open("GET",a.call(f,b+"&when=open"));c.send()};f.abort=function(){c.abort()};return f}}function Q(b,e){var a=h.ActiveXObject;if(a&&!g.crossOrigin(b)){var d,c,f=y(b,e);f.connect=function(){function e(a){var b;(function k(){b=setTimeout(function(){!1!==a()&&k()},1)})();return function(){clearTimeout(b)}}
d=new a("htmlfile");d.open();d.close();var g=d.createElement("iframe");g.src=b+"&when=open";d.body.appendChild(g);var h=g.contentDocument||g.contentWindow.document;c=e(function(){function a(){var c=b.cloneNode(!0);c.appendChild(h.createTextNode("."));c=c.innerText.replace(/\r\n/g,"\n");return c.substring(0,c.length-1)}if(h.firstChild){var b=h.body.lastChild;if(!b)return f.fire("error",Error()).fire("close"),!1;f.parse(a());b.innerText="";c=e(function(){var c=a();c&&(b.innerText="",f.parse(c));if("complete"===
h.readyState)return f.fire("close"),!1});return!1}})};f.abort=function(){c();d.execCommand("Stop")};return f}}function G(b,e){if(/^https?:/.test(b)&&"longpoll"===g.parseURI(b).query.transport)return R(b,e)||S(b,e)||T(b,e)}function C(b,e){var a=I(b,e);a.connect=function(){a.poll(b+"&when=open",function(d){d=g.parseURI(d).query;a.id=d.id;(function f(){a.poll(g.stringifyURI(b,{id:a.id,when:"poll"}),function(b){b?(f(),"string"===typeof b?a.fire("text",b):a.fire("binary",b)):a.fire("close")})})();a.fire("open")})};
return a}function R(b,e){if(!g.crossOrigin(b)||g.corsable){var a,d=C(b,e);d.poll=function(b,e){a=g.createXMLHttpRequest();a.onreadystatechange=function(){switch(a.readyState){case 2:"application/octet-stream"===a.getResponseHeader("content-type")&&(a.responseType="arraybuffer");break;case 4:200===a.status?e(a.response||a.responseText):d.fire("error",Error()).fire("close")}};a.open("GET",b);g.corsable&&(a.withCredentials=!0);a.send(null)};d.abort=function(){a.abort()};return d}}function S(b,e){var a=
e&&e.xdrURL,d=h.XDomainRequest;if(a&&d){var c,f=C(b,e);f.poll=function(b,e){b=a.call(f,b);c=new d;c.onload=function(){e(c.responseText)};c.onerror=function(){f.fire("error",Error()).fire("close")};c.open("GET",b);c.send()};f.abort=function(){c.abort()};return f}}function T(b,e){var a,d=C(b,e),c=J.pop()||"socket_"+u++;h[c]=function(b){a.responseText=b};d.on("close",function(){h[c]=function(){};J.push(c)});d.poll=function(b,e){a=q.createElement("script");a.async=!0;a.src=g.stringifyURI(b,{jsonp:"true",
callback:c});a.clean=function(){a.clean=a.onerror=a.onreadystatechange=a.responseText=null;a.parentNode&&a.parentNode.removeChild(a)};a.onreadystatechange=function(){/loaded|complete/.test(a.readyState)&&(a.clean&&a.clean(),e(a.responseText),a.responseText=null)};a.onerror=function(){a.clean();d.fire("error",Error()).fire("close")};x.insertBefore(a,x.firstChild)};d.abort=function(){a.clean&&a.clean()};return d}var u=1,A=Array.prototype.slice,K=Object.prototype.toString,U=Object.prototype.hasOwnProperty,
q=h.document,z=h.location,V=h.navigator,x=q.head||q.getElementsByTagName("head")[0]||q.documentElement,g={};g.isArray=Array.isArray||function(b){return"[object Array]"===K.call(b)};g.makeAbsolute=function(b){var e=q.createElement("div");e.innerHTML='<a href="'+b+'"/>';return encodeURI(decodeURI(e.firstChild.href))};g.on=function(b,e,a){b.addEventListener?b.addEventListener(e,a,!1):b.attachEvent&&b.attachEvent("on"+e,a)};g.stringifyURI=function(b,e){var a,d=[];e=e||{};e._=u++;for(a in e)null!=e[a]&&
d.push(encodeURIComponent(a)+"="+encodeURIComponent(e[a]));return b+(/\?/.test(b)?"&":"?")+d.join("&").replace(/%20/g,"+")};g.parseURI=function(b){var e={query:{}};if(b=/.*\?([^#]*)/.exec(b)){b=b[1].split("&");for(var a=0;a<b.length;a++){var d=b[a].split("=");e.query[decodeURIComponent(d[0])]=decodeURIComponent(d[1]||"")}}return e};g.createXMLHttpRequest=function(){try{return new h.XMLHttpRequest}catch(b){try{return new h.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}};g.parseJSON=h.JSON?h.JSON.parse:
function(b){return Function("return "+b)()};g.stringifyJSON=h.JSON?h.JSON.stringify:function(b){function e(a){return'"'+a.replace(d,function(a){var b=c[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function a(a){return 10>a?"0"+a:a}var d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,c={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function l(b,
c){var d,g,h,k=c[b];h=typeof k;k&&"object"===typeof k&&"function"===typeof k.toJSON&&(k=k.toJSON(b),h=typeof k);switch(h){case "string":return e(k);case "number":return isFinite(k)?String(k):"null";case "boolean":return String(k);case "object":if(!k)return"null";switch(K.call(k)){case "[object Date]":return isFinite(k.valueOf())?'"'+k.getUTCFullYear()+"-"+a(k.getUTCMonth()+1)+"-"+a(k.getUTCDate())+"T"+a(k.getUTCHours())+":"+a(k.getUTCMinutes())+":"+a(k.getUTCSeconds())+'Z"':"null";case "[object Array]":g=
k.length;h=[];for(d=0;d<g;d++)h.push(l(d,k)||"null");return"["+h.join(",")+"]";default:h=[];for(d in k)U.call(k,d)&&(g=l(d,k))&&h.push(e(d)+":"+g);return"{"+h.join(",")+"}"}}}("",{"":b})};g.corsable="withCredentials"in g.createXMLHttpRequest();g.browser=function(){var b=V.userAgent.toLowerCase(),e={},b=/(msie) ([\w.]+)/.exec(b)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(b)||0>b.indexOf("android")&&/version\/(.+) (safari)/.exec(b)||[];"safari"===b[2]&&(b[2]=b[1],b[1]="safari");e[b[1]||""]=!0;e.version=
b[2]||"0";e.vmajor=e.version.split(".")[0];e.trident&&(e.msie=!0);return e}();g.crossOrigin=function(b){b=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(b.toLowerCase());return!(!b||b[1]==z.protocol&&b[2]==z.hostname&&(b[3]||("http:"===b[1]?80:443))==(z.port||("http:"===z.protocol?80:443)))};var J=[],t=[];g.on(h,"unload",function(){for(var b,e=0;e<t.length;e++)b=t[e],"closed"!==b.state()&&b.close()});g.on(h,"online",function(){for(var b,e=0;e<t.length;e++)b=t[e],"waiting"===b.state()&&b.open()});
g.on(h,"offline",function(){for(var b,e=0;e<t.length;e++)b=t[e],"opened"===b.state()&&b.fire("error",Error()).fire("close")});return{open:function(b,e){var a=v(b,e);t.push(a);return a},transport:{createWebSocketTransport:E,createHttpStreamTransport:F,createHttpLongpollTransport:G},util:g}});