/* Vibe v3.0.0-Alpha9 | http://vibe-project.github.io/projects/vibe-javascript-client/ | (c) 2014, The Vibe Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(g,n){if("function"===typeof define&&define.amd)define([],function(){return n(g)});else if("object"===typeof exports){var u=require("jsdom").jsdom().parentWindow;u.WebSocket=require("ws");u.EventSource=require("eventsource");module.exports=n(u);module.exports.util.corsable=!0}else g.vibe=n(g)})(this,function(g){function n(b){var d,a,c,e,h,l,f=[],g=function(p,m){m=m||[];a=!b||[p,m];c=!0;l=e||0;e=0;for(h=f.length;l<h&&!d;l++)f[l].apply(p,m);c=!1};return{add:function(b){var l=f.length;f.push(b);
c?h=f.length:!d&&a&&!0!==a&&(e=l,g(a[0],a[1]))},remove:function(a){var b;for(b=0;b<f.length;b++)if(a===f[b]||a.guid&&a.guid===f[b].guid)c&&b<=h&&(h--,b<=l&&l--),f.splice(b--,1)},fire:function(e,h){d||c||b&&a||g(e,h)},lock:function(){d=!0},locked:function(){return!!d},unlock:function(){d=a=c=e=h=l=void 0}}}function u(b,d){var a={reconnect:function(a){return 2*(a||250)},transports:[E,F,G],timeout:3E3,xdrURL:null};if(d)for(var c in d)a[c]=d[c];d=a;var e={},h={};e.on=function(a,b){var e;e=h[a];if(!e){if(h.message.locked())return this;
e=h[a]=n();e.order=h.message.order}e.add(b);return this};e.off=function(a,b){var e=h[a];e&&e.remove(b);return this};e.once=function(a,b){function d(){e.off(a,d);b.apply(e,arguments)}b.guid=b.guid||t++;d.guid=b.guid;return e.on(a,d)};e.fire=function(a){var b=h[a];b&&b.fire(e,z.call(arguments,1));return this};var l,v,g,p;e.open=function(){m="preparing";l=null;clearTimeout(v);p&&p++;for(var a in h)h[a].unlock();return e.fire("connecting")};e.close=function(){d.reconnect=!1;clearTimeout(v);l?l.close():
e.fire("close");return this};var m;e.state=function(){return m};for(c in{connecting:1,open:1,close:1,waiting:1})h[c]=n(!0),h[c].order=t++;h.message=n(!1);h.message.order=h.open.order;e.on("connecting",function(){m="connecting";for(var a=f.isArray(b)?z.call(b):[b],h=0;h<a.length;h++){var c=a[h]=f.makeAbsolute(a[h]);/^https?:/.test(c)&&!f.parseURI(c).query.transport&&a.splice(h,1,c.replace(/^http/,"ws"),f.stringifyURI(c,{transport:"stream"}),f.stringifyURI(c,{transport:"longpoll"}))}(function w(){function b(){c.off("close",
w).close()}var h=a.shift();if(h){for(var c,g=0;g<d.transports.length&&!(c=d.transports[g](h,d));g++);c?(e.once("close",b),c.open().on("close",w).on("text",function L(a){c.off("text",L);a=f.parseURI(a).query;d.heartbeat=+a.heartbeat;d._heartbeat=+a._heartbeat||5E3;l=c.off("close",w);var h;l.on("text",function(a){if(h){var b=f.parseJSON(a),c;a=function(a){return function(h){c||(c=!0,e.send("reply",{id:b.id,data:h,exception:!a}))}};a=[b.type,b.data,b.reply?{resolve:a(!0),reject:a(!1)}:null];e.fire.apply(e,
a)}else h=!0}).on("error",function(a){e.fire("error",a)}).on("close",function(){e.fire("close")});e.off("close",b).fire("open")})):w()}else e.fire("error",Error()).fire("close")})()}).on("open",function(){m="opened";var a;(function K(){a=setTimeout(function(){e.send("heartbeat").once("heartbeat",function(){clearTimeout(a);K()});a=setTimeout(function(){e.fire("error",Error("heartbeat"));l.close()},d._heartbeat)},d.heartbeat-d._heartbeat)})();e.once("close",function(){clearTimeout(a)});h.connecting.lock();
v=g=p=null}).on("close",function(){m="closed";for(var a in h){var b=h[a];b.order<h.close.order&&b.lock()}if(d.reconnect)e.once("close",function(){p=p||1;g=d.reconnect.call(e,g,p);!1!==g&&(v=setTimeout(function(){e.open()},g),e.fire("waiting",g,p))})}).on("waiting",function(){m="waiting"});var A={};e.send=function(a,b,c,h){if("opened"!==m)return e.fire(Error("notopened")),this;a={id:t++,type:a,data:b,reply:!(!c&&!h)};a.reply&&(A[a.id]=[c,h]);l.send(f.stringifyJSON(a));return this};e.on("reply",function(a){A[a.id][+a.exception].call(e,
a.data);delete A[a.id]});return e.open()}function H(b,d){var a={open:function(){function b(){clearTimeout(c)}a.connect();var c=setTimeout(function(){a.fire("error",Error("timeout")).close()},d.timeout);a.on("open",b).on("close",b);return this}},c={open:n(!0),text:n(),error:n(),close:n(!0)};a.on=function(a,b){c[a].add(b);return this};a.off=function(a,b){c[a].remove(b);return this};a.fire=function(b){c[b].fire(a,z.call(arguments,1));return this};return a}function E(b,d){var a=g.WebSocket;if(a&&/^wss?:/.test(b)){var c,
e=H(b,d);e.connect=function(){c=new a(b);c.onopen=function(){e.fire("open")};c.onmessage=function(a){"string"===typeof a.data&&e.fire("text",a.data)};c.onerror=function(){e.fire("error",Error()).fire("close")};c.onclose=function(){e.fire("close")}};e.send=function(a){c.send(a)};e.close=function(){c.close()};return e}}function B(b,d){var a=H(b,d),c;a.on("open",function(){c=f.stringifyURI(b,{id:a.id})}).on("close",function(){c=null});a.send=!f.crossOrigin(b)||f.corsable?function(b){var d=f.createXMLHttpRequest();
d.onreadystatechange=function(){4===d.readyState&&200!==d.status&&c&&a.send(b)};d.open("POST",c);d.setRequestHeader("content-type","text/plain; charset=UTF-8");f.corsable&&(d.withCredentials=!0);d.send("data="+b)}:g.XDomainRequest&&d.xdrURL?function(b){var e=new g.XDomainRequest;e.onerror=function(){c&&a.send(b)};e.open("POST",d.xdrURL.call(a,c));e.send("data="+b)}:function(b){var d,e=q.createElement("form");e.action=c;e.target="socket-"+t++;e.method="POST";e.enctype=e.encoding="text/plain";e.acceptCharset=
"UTF-8";e.style.display="none";e.innerHTML='<textarea name="data"></textarea><iframe name="'+e.target+'"></iframe>';e.firstChild.value=b;d=e.lastChild;f.on(d,"error",function(){c&&a.send(b)});f.on(d,"load",function(){q.body.removeChild(e)});q.body.appendChild(e);e.submit()};var e;a.close=function(){a.abort();if(!e){e=!0;var c=q.createElement("script");c.async=!1;c.src=f.stringifyURI(b,{id:a.id,when:"abort"});c.onload=c.onerror=c.onreadystatechange=function(){if(!c.readyState||/loaded|complete/.test(c.readyState))c.onload=
c.onreadystatechange=null,c.parentNode&&c.parentNode.removeChild(c),a.fire("close")};x.insertBefore(c,x.firstChild)}};return a}function F(b,d){if(/^https?:/.test(b)&&"stream"===f.parseURI(b).query.transport)return M(b,d)||N(b,d)||O(b,d)||P(b,d)}function M(b,d){var a=g.EventSource;if(a&&!(f.crossOrigin(b)&&f.browser.safari&&7>f.browser.vmajor)){var c,e=B(b,d);e.connect=function(){c=new a(b+"&when=open&sse=true",{withCredentials:!0});var d;c.onmessage=function(a){d?e.fire("text",a.data):(d=!0,a=f.parseURI(a.data).query,
e.id=a.id,e.fire("open"))};c.onerror=function(){c.close();e.fire("close")}};e.abort=function(){c.close()};return e}}function C(b,d){var a="",c=B(b,d),e;c.parse=function(b){if(b=b.replace(/^\s+/,"")){b=(a+b).split("\n\n");for(var d=0;d<b.length-1;d++){var g=b[d].substring(6);e?c.fire("text",g):(e=!0,g=f.parseURI(g).query,c.id=g.id,c.fire("open"))}a=b[b.length-1]}};return c}function N(b,d){if(!(f.browser.msie&&10>f.browser.vmajor||f.crossOrigin(b)&&!f.corsable)){var a,c=C(b,d);c.connect=function(){var d;
a=f.createXMLHttpRequest();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(c.parse(d?a.responseText.substring(d):a.responseText),d=a.responseText.length):4===a.readyState&&(200!==a.status&&c.fire("error",Error()),c.fire("close"))};a.open("GET",b+"&when=open");f.corsable&&(a.withCredentials=!0);a.send()};c.abort=function(){a.abort()};return c}}function O(b,d){var a=g.XDomainRequest;if(a&&d.xdrURL){var c,e=C(b,d);e.connect=function(){var h;c=new a;c.onprogress=function(){e.parse(h?
c.responseText.substring(h):c.responseText);h=c.responseText.length};c.onerror=function(){e.fire("error",Error()).fire("close")};c.onload=function(){e.fire("close")};c.open("GET",d.xdrURL.call(e,b+"&when=open"));c.send()};e.abort=function(){c.abort()};return e}}function P(b,d){var a=g.ActiveXObject;if(a&&!f.crossOrigin(b)){var c,e,h=C(b,d);h.connect=function(){function d(a){var b;(function k(){b=setTimeout(function(){!1!==a()&&k()},1)})();return function(){clearTimeout(b)}}c=new a("htmlfile");c.open();
c.close();var f=c.createElement("iframe");f.src=b+"&when=open";c.body.appendChild(f);var g=f.contentDocument||f.contentWindow.document;e=d(function(){function a(){var c=b.cloneNode(!0);c.appendChild(g.createTextNode("."));c=c.innerText.replace(/\r\n/g,"\n");return c.substring(0,c.length-1)}if(g.firstChild){var b=g.body.lastChild;if(!b)return h.fire("error",Error()).fire("close"),!1;h.parse(a());b.innerText="";e=d(function(){var c=a();c&&(b.innerText="",h.parse(c));if("complete"===g.readyState)return h.fire("close"),
!1});return!1}})};h.abort=function(){e();c.execCommand("Stop")};return h}}function G(b,d){if(/^https?:/.test(b)&&"longpoll"===f.parseURI(b).query.transport)return Q(b,d)||R(b,d)||S(b,d)}function D(b,d){var a=B(b,d);a.connect=function(){a.poll(b+"&when=open",function(c){c=f.parseURI(c).query;a.id=c.id;(function h(){a.poll(f.stringifyURI(b,{id:a.id,when:"poll"}),function(b){b?(h(),a.fire("text",b)):a.fire("close")})})();a.fire("open")})};return a}function Q(b,d){if(!f.crossOrigin(b)||f.corsable){var a,
c=D(b,d);c.poll=function(b,d){a=f.createXMLHttpRequest();a.onreadystatechange=function(){4===a.readyState&&(200===a.status?d(a.responseText):c.fire("error",Error()))};a.open("GET",b);f.corsable&&(a.withCredentials=!0);a.send(null)};c.abort=function(){a.abort()};return c}}function R(b,d){var a=g.XDomainRequest;if(a&&d.xdrURL){var c,e=D(b,d);e.poll=function(b,f){b=d.xdrURL.call(e,b);c=new a;c.onload=function(){f(c.responseText)};c.onerror=function(){e.fire("error",Error()).fire("close")};c.open("GET",
b);c.send()};e.abort=function(){c.abort()};return e}}function S(b,d){var a,c=D(b,d),e=I.pop()||"socket_"+t++;g[e]=function(b){a.responseText=b};c.on("close",function(){g[e]=function(){};I.push(e)});c.poll=function(b,d){a=q.createElement("script");a.async=!0;a.src=f.stringifyURI(b,{jsonp:"true",callback:e});a.clean=function(){a.clean=a.onerror=a.onload=a.onreadystatechange=a.responseText=null;a.parentNode&&a.parentNode.removeChild(a)};a.onload=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.clean&&
a.clean(),d(a.responseText)};a.onerror=function(){a.clean();c.fire("error",Error()).fire("close")};x.insertBefore(a,x.firstChild)};c.abort=function(){a.clean&&a.clean()};return c}var t=1,z=Array.prototype.slice,J=Object.prototype.toString,T=Object.prototype.hasOwnProperty,q=g.document,y=g.location,U=g.navigator,x=q.head||q.getElementsByTagName("head")[0]||q.documentElement,f={};f.isArray=Array.isArray||function(b){return"[object Array]"===J.call(b)};f.makeAbsolute=function(b){var d=q.createElement("div");
d.innerHTML='<a href="'+b+'"/>';return encodeURI(decodeURI(d.firstChild.href))};f.on=function(b,d,a){b.addEventListener?b.addEventListener(d,a,!1):b.attachEvent&&b.attachEvent("on"+d,a)};f.stringifyURI=function(b,d){var a,c=[];d=d||{};d._=t++;for(a in d)null!=d[a]&&c.push(encodeURIComponent(a)+"="+encodeURIComponent(d[a]));return b+(/\?/.test(b)?"&":"?")+c.join("&").replace(/%20/g,"+")};f.parseURI=function(b){var d={query:{}};if(b=/.*\?([^#]*)/.exec(b)){b=b[1].split("&");for(var a=0;a<b.length;a++){var c=
b[a].split("=");d.query[decodeURIComponent(c[0])]=decodeURIComponent(c[1]||"")}}return d};f.createXMLHttpRequest=function(){try{return new g.XMLHttpRequest}catch(b){try{return new g.ActiveXObject("Microsoft.XMLHTTP")}catch(d){}}};f.parseJSON=g.JSON?g.JSON.parse:function(b){return Function("return "+b)()};f.stringifyJSON=g.JSON?g.JSON.stringify:function(b){function d(a){return'"'+a.replace(c,function(a){var b=e[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+
'"'}function a(a){return 10>a?"0"+a:a}var c=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function l(b,c){var e,f,g,k=c[b];g=typeof k;k&&"object"===typeof k&&"function"===typeof k.toJSON&&(k=k.toJSON(b),g=typeof k);switch(g){case "string":return d(k);case "number":return isFinite(k)?String(k):"null";case "boolean":return String(k);case "object":if(!k)return"null";
switch(J.call(k)){case "[object Date]":return isFinite(k.valueOf())?'"'+k.getUTCFullYear()+"-"+a(k.getUTCMonth()+1)+"-"+a(k.getUTCDate())+"T"+a(k.getUTCHours())+":"+a(k.getUTCMinutes())+":"+a(k.getUTCSeconds())+'Z"':"null";case "[object Array]":f=k.length;g=[];for(e=0;e<f;e++)g.push(l(e,k)||"null");return"["+g.join(",")+"]";default:g=[];for(e in k)T.call(k,e)&&(f=l(e,k))&&g.push(d(e)+":"+f);return"{"+g.join(",")+"}"}}}("",{"":b})};f.corsable="withCredentials"in f.createXMLHttpRequest();f.browser=
function(){var b=U.userAgent.toLowerCase(),d={},b=/(msie) ([\w.]+)/.exec(b)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(b)||0>b.indexOf("android")&&/version\/(.+) (safari)/.exec(b)||[];"safari"===b[2]&&(b[2]=b[1],b[1]="safari");d[b[1]||""]=!0;d.version=b[2]||"0";d.vmajor=d.version.split(".")[0];d.trident&&(d.msie=!0);return d}();f.crossOrigin=function(b){b=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(b.toLowerCase());return!(!b||b[1]==y.protocol&&b[2]==y.hostname&&(b[3]||("http:"===b[1]?80:443))==
(y.port||("http:"===y.protocol?80:443)))};var I=[],r=[];f.on(g,"unload",function(){for(var b,d=0;d<r.length;d++)b=r[d],"closed"!==b.state()&&b.close()});f.on(g,"online",function(){for(var b,d=0;d<r.length;d++)b=r[d],"waiting"===b.state()&&b.open()});f.on(g,"offline",function(){for(var b,d=0;d<r.length;d++)b=r[d],"opened"===b.state()&&b.fire("error",Error()).fire("close")});return{open:function(b,d){var a=u(b,d);r.push(a);return a},transport:{createWebSocketTransport:E,createHttpStreamTransport:F,
createHttpLongpollTransport:G},util:f}});