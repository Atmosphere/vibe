/* Vibe v3.0.0-Alpha10 | http://vibe-project.github.io/projects/vibe-javascript-client/ | (c) 2014, The Vibe Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(g,n){if("function"===typeof define&&define.amd)define([],function(){return n(g)});else if("object"===typeof exports){var u=require("jsdom").jsdom().parentWindow;u.WebSocket=require("ws");u.EventSource=require("eventsource");module.exports=n(u);module.exports.util.corsable=!0}else g.vibe=n(g)})(this,function(g){function n(b){var c,a,d,e,h,l,f=[],g=function(p,m){m=m||[];a=!b||[p,m];d=!0;l=e||0;e=0;for(h=f.length;l<h&&!c;l++)f[l].apply(p,m);d=!1};return{add:function(b){var l=f.length;f.push(b);
d?h=f.length:!c&&a&&!0!==a&&(e=l,g(a[0],a[1]))},remove:function(a){var b;for(b=0;b<f.length;b++)if(a===f[b]||a.guid&&a.guid===f[b].guid)d&&b<=h&&(h--,b<=l&&l--),f.splice(b--,1)},fire:function(e,h){c||d||b&&a||g(e,h)},lock:function(){c=!0},locked:function(){return!!c},unlock:function(){c=a=d=e=h=l=void 0}}}function u(b,c){var a={reconnect:function(a){return 2*(a||250)},transports:[E,F,G],timeout:3E3,xdrURL:null};if(c)for(var d in c)a[d]=c[d];c=a;var e={},h={};e.on=function(a,b){var c;c=h[a];if(!c){if(h.message.locked())return this;
c=h[a]=n();c.order=h.message.order}c.add(b);return this};e.off=function(a,b){var c=h[a];c&&c.remove(b);return this};e.once=function(a,b){function c(){e.off(a,c);b.apply(e,arguments)}b.guid=b.guid||t++;c.guid=b.guid;return e.on(a,c)};e.fire=function(a){var b=h[a];b&&b.fire(e,z.call(arguments,1));return this};var l,v,g,p;e.open=function(){m="preparing";l=null;clearTimeout(v);p&&p++;for(var a in h)h[a].unlock();return e.fire("connecting")};e.close=function(){c.reconnect=!1;clearTimeout(v);l?l.close():
e.fire("close");return this};var m;e.state=function(){return m};for(d in{connecting:1,open:1,close:1,waiting:1})h[d]=n(!0),h[d].order=t++;h.message=n(!1);h.message.order=h.open.order;e.on("connecting",function(){m="connecting";for(var a=f.isArray(b)?z.call(b):[b],h=0;h<a.length;h++){var d=a[h]=f.makeAbsolute(a[h]);/^https?:/.test(d)&&!f.parseURI(d).query.transport&&a.splice(h,1,d.replace(/^http/,"ws"),f.stringifyURI(d,{transport:"stream"}),f.stringifyURI(d,{transport:"longpoll"}))}(function w(){function b(){d.off("close",
w).close()}var h=a.shift();if(h){for(var d,g=0;g<c.transports.length&&!(d=c.transports[g](h,c));g++);d?(e.once("close",b),d.open().on("close",w).on("text",function L(a){d.off("text",L);a=f.parseURI(a).query;c.heartbeat=+a.heartbeat;c._heartbeat=+a._heartbeat||5E3;l=d.off("close",w);var h;l.on("text",function(a){if(h){var b=f.parseJSON(a),c;a=function(a){return function(d){c||(c=!0,e.send("reply",{id:b.id,data:d,exception:!a}))}};a=[b.type,b.data,b.reply?{resolve:a(!0),reject:a(!1)}:null];e.fire.apply(e,
a)}else h=!0}).on("error",function(a){e.fire("error",a)}).on("close",function(){e.fire("close")});e.off("close",b).fire("open")})):w()}else e.fire("error",Error()).fire("close")})()}).on("open",function(){m="opened";var a;(function K(){a=setTimeout(function(){e.send("heartbeat").once("heartbeat",function(){clearTimeout(a);K()});a=setTimeout(function(){e.fire("error",Error("heartbeat"));l.close()},c._heartbeat)},c.heartbeat-c._heartbeat)})();e.once("close",function(){clearTimeout(a)});h.connecting.lock();
v=g=p=null}).on("close",function(){m="closed";for(var a in h){var b=h[a];b.order<h.close.order&&b.lock()}if(c.reconnect)e.once("close",function(){p=p||1;g=c.reconnect.call(e,g,p);!1!==g&&(v=setTimeout(function(){e.open()},g),e.fire("waiting",g,p))})}).on("waiting",function(){m="waiting"});var A={};e.send=function(a,b,c,d){if("opened"!==m)return e.fire(Error("notopened")),this;a={id:t++,type:a,data:b,reply:!(!c&&!d)};a.reply&&(A[a.id]=[c,d]);l.send(f.stringifyJSON(a));return this};e.on("reply",function(a){A[a.id][+a.exception].call(e,
a.data);delete A[a.id]});return e.open()}function H(b,c){c=c||{timeout:3E3};var a={open:function(){function b(){clearTimeout(d)}a.connect();var d=setTimeout(function(){a.fire("error",Error("timeout")).close()},c.timeout);a.on("open",b).on("close",b);return this}},d={open:n(!0),text:n(),error:n(),close:n(!0)};a.on=function(a,b){d[a].add(b);return this};a.off=function(a,b){d[a].remove(b);return this};a.fire=function(b){d[b].fire(a,z.call(arguments,1));return this};return a}function E(b,c){var a=g.WebSocket;
if(a&&/^wss?:/.test(b)){var d,e=H(b,c);e.connect=function(){d=new a(b);d.onopen=function(){e.fire("open")};d.onmessage=function(a){"string"===typeof a.data&&e.fire("text",a.data)};d.onerror=function(){e.fire("error",Error()).fire("close")};d.onclose=function(){e.fire("close")}};e.send=function(a){d.send(a);return this};e.close=function(){d.close();return this};return e}}function B(b,c){var a=H(b,c),d;a.on("open",function(){d=f.stringifyURI(b,{id:a.id})}).on("close",function(){d=null});a.send=!f.crossOrigin(b)||
f.corsable?function(b){var c=f.createXMLHttpRequest();c.onreadystatechange=function(){4===c.readyState&&200!==c.status&&d&&a.send(b)};c.open("POST",d);c.setRequestHeader("content-type","text/plain; charset=UTF-8");f.corsable&&(c.withCredentials=!0);c.send("data="+b);return this}:g.XDomainRequest&&c.xdrURL?function(b){var e=new g.XDomainRequest;e.onerror=function(){d&&a.send(b)};e.open("POST",c.xdrURL.call(a,d));e.send("data="+b);return this}:function(b){var c,e=q.createElement("form");e.action=d;
e.target="socket-"+t++;e.method="POST";e.enctype=e.encoding="text/plain";e.acceptCharset="UTF-8";e.style.display="none";e.innerHTML='<textarea name="data"></textarea><iframe name="'+e.target+'"></iframe>';e.firstChild.value=b;c=e.lastChild;f.on(c,"error",function(){d&&a.send(b)});f.on(c,"load",function(){q.body.removeChild(e)});q.body.appendChild(e);e.submit();return this};var e;a.close=function(){a.abort();if(!e){e=!0;var c=q.createElement("script");c.async=!1;c.src=f.stringifyURI(b,{id:a.id,when:"abort"});
c.onload=c.onerror=c.onreadystatechange=function(){if(!c.readyState||/loaded|complete/.test(c.readyState))c.onload=c.onreadystatechange=null,c.parentNode&&c.parentNode.removeChild(c),a.fire("close")};x.insertBefore(c,x.firstChild)}return this};return a}function F(b,c){if(/^https?:/.test(b)&&"stream"===f.parseURI(b).query.transport)return M(b,c)||N(b,c)||O(b,c)||P(b,c)}function M(b,c){var a=g.EventSource;if(a&&!(f.crossOrigin(b)&&f.browser.safari&&7>f.browser.vmajor)){var d,e=B(b,c);e.connect=function(){d=
new a(b+"&when=open&sse=true",{withCredentials:!0});var c;d.onmessage=function(a){c?e.fire("text",a.data):(c=!0,a=f.parseURI(a.data).query,e.id=a.id,e.fire("open"))};d.onerror=function(){d.close();e.fire("close")}};e.abort=function(){d.close()};return e}}function C(b,c){var a="",d=B(b,c),e;d.parse=function(b){if(b=b.replace(/^\s+/,"")){b=(a+b).split("\n\n");for(var c=0;c<b.length-1;c++){var g=b[c].substring(6);e?d.fire("text",g):(e=!0,g=f.parseURI(g).query,d.id=g.id,d.fire("open"))}a=b[b.length-1]}};
return d}function N(b,c){if(!(f.browser.msie&&10>f.browser.vmajor||f.crossOrigin(b)&&!f.corsable)){var a,d=C(b,c);d.connect=function(){var c;a=f.createXMLHttpRequest();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(d.parse(c?a.responseText.substring(c):a.responseText),c=a.responseText.length):4===a.readyState&&(200!==a.status&&d.fire("error",Error()),d.fire("close"))};a.open("GET",b+"&when=open");f.corsable&&(a.withCredentials=!0);a.send()};d.abort=function(){a.abort()};return d}}
function O(b,c){var a=g.XDomainRequest;if(a&&c.xdrURL){var d,e=C(b,c);e.connect=function(){var h;d=new a;d.onprogress=function(){e.parse(h?d.responseText.substring(h):d.responseText);h=d.responseText.length};d.onerror=function(){e.fire("error",Error()).fire("close")};d.onload=function(){e.fire("close")};d.open("GET",c.xdrURL.call(e,b+"&when=open"));d.send()};e.abort=function(){d.abort()};return e}}function P(b,c){var a=g.ActiveXObject;if(a&&!f.crossOrigin(b)){var d,e,h=C(b,c);h.connect=function(){function c(a){var b;
(function k(){b=setTimeout(function(){!1!==a()&&k()},1)})();return function(){clearTimeout(b)}}d=new a("htmlfile");d.open();d.close();var f=d.createElement("iframe");f.src=b+"&when=open";d.body.appendChild(f);var g=f.contentDocument||f.contentWindow.document;e=c(function(){function a(){var c=b.cloneNode(!0);c.appendChild(g.createTextNode("."));c=c.innerText.replace(/\r\n/g,"\n");return c.substring(0,c.length-1)}if(g.firstChild){var b=g.body.lastChild;if(!b)return h.fire("error",Error()).fire("close"),
!1;h.parse(a());b.innerText="";e=c(function(){var c=a();c&&(b.innerText="",h.parse(c));if("complete"===g.readyState)return h.fire("close"),!1});return!1}})};h.abort=function(){e();d.execCommand("Stop")};return h}}function G(b,c){if(/^https?:/.test(b)&&"longpoll"===f.parseURI(b).query.transport)return Q(b,c)||R(b,c)||S(b,c)}function D(b,c){var a=B(b,c);a.connect=function(){a.poll(b+"&when=open",function(c){c=f.parseURI(c).query;a.id=c.id;(function h(){a.poll(f.stringifyURI(b,{id:a.id,when:"poll"}),
function(b){b?(h(),a.fire("text",b)):a.fire("close")})})();a.fire("open")})};return a}function Q(b,c){if(!f.crossOrigin(b)||f.corsable){var a,d=D(b,c);d.poll=function(b,c){a=f.createXMLHttpRequest();a.onreadystatechange=function(){4===a.readyState&&(200===a.status?c(a.responseText):d.fire("error",Error()))};a.open("GET",b);f.corsable&&(a.withCredentials=!0);a.send(null)};d.abort=function(){a.abort()};return d}}function R(b,c){var a=g.XDomainRequest;if(a&&c.xdrURL){var d,e=D(b,c);e.poll=function(b,
f){b=c.xdrURL.call(e,b);d=new a;d.onload=function(){f(d.responseText)};d.onerror=function(){e.fire("error",Error()).fire("close")};d.open("GET",b);d.send()};e.abort=function(){d.abort()};return e}}function S(b,c){var a,d=D(b,c),e=I.pop()||"socket_"+t++;g[e]=function(b){a.responseText=b};d.on("close",function(){g[e]=function(){};I.push(e)});d.poll=function(b,c){a=q.createElement("script");a.async=!0;a.src=f.stringifyURI(b,{jsonp:"true",callback:e});a.clean=function(){a.clean=a.onerror=a.onload=a.onreadystatechange=
a.responseText=null;a.parentNode&&a.parentNode.removeChild(a)};a.onload=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.clean&&a.clean(),c(a.responseText)};a.onerror=function(){a.clean();d.fire("error",Error()).fire("close")};x.insertBefore(a,x.firstChild)};d.abort=function(){a.clean&&a.clean()};return d}var t=1,z=Array.prototype.slice,J=Object.prototype.toString,T=Object.prototype.hasOwnProperty,q=g.document,y=g.location,U=g.navigator,x=q.head||q.getElementsByTagName("head")[0]||
q.documentElement,f={};f.isArray=Array.isArray||function(b){return"[object Array]"===J.call(b)};f.makeAbsolute=function(b){var c=q.createElement("div");c.innerHTML='<a href="'+b+'"/>';return encodeURI(decodeURI(c.firstChild.href))};f.on=function(b,c,a){b.addEventListener?b.addEventListener(c,a,!1):b.attachEvent&&b.attachEvent("on"+c,a)};f.stringifyURI=function(b,c){var a,d=[];c=c||{};c._=t++;for(a in c)null!=c[a]&&d.push(encodeURIComponent(a)+"="+encodeURIComponent(c[a]));return b+(/\?/.test(b)?"&":
"?")+d.join("&").replace(/%20/g,"+")};f.parseURI=function(b){var c={query:{}};if(b=/.*\?([^#]*)/.exec(b)){b=b[1].split("&");for(var a=0;a<b.length;a++){var d=b[a].split("=");c.query[decodeURIComponent(d[0])]=decodeURIComponent(d[1]||"")}}return c};f.createXMLHttpRequest=function(){try{return new g.XMLHttpRequest}catch(b){try{return new g.ActiveXObject("Microsoft.XMLHTTP")}catch(c){}}};f.parseJSON=g.JSON?g.JSON.parse:function(b){return Function("return "+b)()};f.stringifyJSON=g.JSON?g.JSON.stringify:
function(b){function c(a){return'"'+a.replace(d,function(a){var b=e[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function a(a){return 10>a?"0"+a:a}var d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function l(b,d){var e,f,g,k=d[b];g=typeof k;k&&"object"===typeof k&&"function"===typeof k.toJSON&&
(k=k.toJSON(b),g=typeof k);switch(g){case "string":return c(k);case "number":return isFinite(k)?String(k):"null";case "boolean":return String(k);case "object":if(!k)return"null";switch(J.call(k)){case "[object Date]":return isFinite(k.valueOf())?'"'+k.getUTCFullYear()+"-"+a(k.getUTCMonth()+1)+"-"+a(k.getUTCDate())+"T"+a(k.getUTCHours())+":"+a(k.getUTCMinutes())+":"+a(k.getUTCSeconds())+'Z"':"null";case "[object Array]":f=k.length;g=[];for(e=0;e<f;e++)g.push(l(e,k)||"null");return"["+g.join(",")+"]";
default:g=[];for(e in k)T.call(k,e)&&(f=l(e,k))&&g.push(c(e)+":"+f);return"{"+g.join(",")+"}"}}}("",{"":b})};f.corsable="withCredentials"in f.createXMLHttpRequest();f.browser=function(){var b=U.userAgent.toLowerCase(),c={},b=/(msie) ([\w.]+)/.exec(b)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(b)||0>b.indexOf("android")&&/version\/(.+) (safari)/.exec(b)||[];"safari"===b[2]&&(b[2]=b[1],b[1]="safari");c[b[1]||""]=!0;c.version=b[2]||"0";c.vmajor=c.version.split(".")[0];c.trident&&(c.msie=!0);return c}();f.crossOrigin=
function(b){b=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(b.toLowerCase());return!(!b||b[1]==y.protocol&&b[2]==y.hostname&&(b[3]||("http:"===b[1]?80:443))==(y.port||("http:"===y.protocol?80:443)))};var I=[],r=[];f.on(g,"unload",function(){for(var b,c=0;c<r.length;c++)b=r[c],"closed"!==b.state()&&b.close()});f.on(g,"online",function(){for(var b,c=0;c<r.length;c++)b=r[c],"waiting"===b.state()&&b.open()});f.on(g,"offline",function(){for(var b,c=0;c<r.length;c++)b=r[c],"opened"===b.state()&&
b.fire("error",Error()).fire("close")});return{open:function(b,c){var a=u(b,c);r.push(a);return a},transport:{createWebSocketTransport:E,createHttpStreamTransport:F,createHttpLongpollTransport:G},util:f}});