/* Vibe v3.0.0-Alpha5 | http://vibe-project.github.io/projects/vibe-javascript-client/ | (c) 2014, The Vibe Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(g,p){if("function"===typeof define&&define.amd)define([],function(){return p(g)});else if("object"===typeof exports){var w=require("jsdom").jsdom().parentWindow;w.WebSocket=require("ws");w.EventSource=require("eventsource");module.exports=p(w);module.exports.util.corsable=!0}else g.vibe=p(g)})(this,function(g){function p(c){var a,b,d,e,k,h,f=[],g=function(q,n){n=n||[];b=!c||[q,n];d=!0;h=e||0;e=0;for(k=f.length;h<k&&!a;h++)f[h].apply(q,n);d=!1};return{add:function(c){var h=f.length;f.push(c);
d?k=f.length:!a&&b&&!0!==b&&(e=h,g(b[0],b[1]))},remove:function(a){var b;for(b=0;b<f.length;b++)if(a===f[b]||a.guid&&a.guid===f[b].guid)d&&b<=k&&(k--,b<=h&&h--),f.splice(b--,1)},fire:function(e,k){a||d||c&&b||g(e,k)},lock:function(){a=!0},locked:function(){return!!a},unlock:function(){a=b=d=e=k=h=void 0}}}function w(c,a){var b={reconnect:function(a){return 2*(a||250)},timeout:3E3,transports:["ws","stream","longpoll"],xdrURL:null};if(a)for(var d in a)b[d]=a[d];a=b;a.url=f.makeAbsolute(c);b=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(a.url.toLowerCase());
a.crossOrigin=!(!b||b[1]==y.protocol&&b[2]==y.hostname&&(b[3]||("http:"===b[1]?80:443))==(y.port||("http:"===y.protocol?80:443)));var e={},k={};e.on=function(a,b){var e;e=k[a];if(!e){if(k.message.locked())return this;e=k[a]=p();e.order=k.message.order}e.add(b);return this};e.off=function(a,b){var e=k[a];e&&e.remove(b);return this};e.once=function(a,b){function c(){e.off(a,c);b.apply(e,arguments)}b.guid=b.guid||v++;c.guid=b.guid;return e.on(a,c)};e.fire=function(a){var b=k[a];b&&b.fire(e,B.call(arguments,
1));return this};var h,g,u,q;e.open=function(){n="preparing";h=null;clearTimeout(g);q&&q++;for(var b in k)k[b].unlock();a.transports.length?e.fire("connecting"):e.fire("error",Error("notransport")).fire("close");return this};e.close=function(){a.reconnect=!1;clearTimeout(g);h?h.close():e.fire("close");return this};var n;e.state=function(){return n};for(d in{connecting:1,open:1,close:1,waiting:1})k[d]=p(!0),k[d].order=v++;k.message=p(!1);k.message.order=k.open.order;e.on("connecting",function(){function b(a){h=
a;var c;h.on("message",function(a){if(c){var b=f.parseJSON(a),d;a=function(a){return function(c){d||(d=!0,e.send("reply",{id:b.id,data:c,exception:!a}))}};a=[b.type,b.data,b.reply?{resolve:a(!0),reject:a(!1)}:null];e.fire.apply(e,a)}else c=!0}).on("error",function(a){e.fire("error",a)}).on("close",function(){e.fire("close")})}function c(){var d=g.shift();d?(k=m[d](a))?(a.transport=d,k.on("close",c).on("message",function E(d){k.off("message",E);d=f.parseURI(d).query;a.heartbeat=+d.heartbeat;a._heartbeat=
+d._heartbeat||5E3;b(k.off("close",c));e.fire("open")}).open()):c():e.fire("error",Error()).fire("close")}function d(){k.off("close",c).close()}n="connecting";var k,g=B.call(a.transports);e.once("close",d).once("open",function(){e.off("close",d)});c()}).on("open",function(){n="opened";var b;(function D(){b=setTimeout(function(){e.send("heartbeat").once("heartbeat",function(){clearTimeout(b);D()});b=setTimeout(function(){e.fire("error",Error("heartbeat"));h.close()},a._heartbeat)},a.heartbeat-a._heartbeat)})();
e.once("close",function(){clearTimeout(b)});k.connecting.lock();g=u=q=null}).on("close",function(){n="closed";for(var b in k){var c=k[b];c.order<k.close.order&&c.lock()}if(a.reconnect)e.once("close",function(){q=q||1;u=a.reconnect.call(e,u,q);!1!==u&&(g=setTimeout(function(){e.open()},u),e.fire("waiting",u,q))})}).on("waiting",function(){n="waiting"});var x={};e.send=function(a,b,c,d){"opened"!==n&&e.fire(Error("notopened"));a={id:v++,type:a,data:b,reply:!(!c&&!d)};a.reply&&(x[a.id]=[c,d]);h.send(f.stringifyJSON(a));
return this};e.on("reply",function(a){x[a.id][+a.exception].call(e,a.data);delete x[a.id]});return e.open()}var v=1,B=Array.prototype.slice,F=Object.prototype.toString,G=Object.prototype.hasOwnProperty,r=g.document,y=g.location,H=g.navigator,z=r.head||r.getElementsByTagName("head")[0]||r.documentElement,f={makeAbsolute:function(c){var a=r.createElement("div");a.innerHTML='<a href="'+c+'"/>';return encodeURI(decodeURI(a.firstChild.href))},on:function(c,a,b){c.addEventListener?c.addEventListener(a,
b,!1):c.attachEvent&&c.attachEvent("on"+a,b)},off:function(c,a,b){c.removeEventListener?c.removeEventListener(a,b,!1):c.detachEvent&&c.detachEvent("on"+a,b)},stringifyURI:function(c,a){var b,d=[];a=a||{};a._=v++;for(b in a)null!=a[b]&&d.push(encodeURIComponent(b)+"="+encodeURIComponent(a[b]));return c+(/\?/.test(c)?"&":"?")+d.join("&").replace(/%20/g,"+")},parseURI:function(c){var a={query:{}};if(c=/.*\?([^#]*)/.exec(c)){c=c[1].split("&");for(var b=0;b<c.length;b++){var d=c[b].split("=");a.query[decodeURIComponent(d[0])]=
decodeURIComponent(d[1]||"")}}return a},xhr:function(){try{return new g.XMLHttpRequest}catch(c){try{return new g.ActiveXObject("Microsoft.XMLHTTP")}catch(a){}}}};f.parseJSON=g.JSON?g.JSON.parse:function(c){return Function("return "+c)()};f.stringifyJSON=g.JSON?g.JSON.stringify:function(c){function a(a){return'"'+a.replace(d,function(a){var b=e[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function b(a){return 10>a?"0"+a:a}var d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,
e={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function h(c,e){var d,f,g,l=e[c];g=typeof l;l&&"object"===typeof l&&"function"===typeof l.toJSON&&(l=l.toJSON(c),g=typeof l);switch(g){case "string":return a(l);case "number":return isFinite(l)?String(l):"null";case "boolean":return String(l);case "object":if(!l)return"null";switch(F.call(l)){case "[object Date]":return isFinite(l.valueOf())?'"'+l.getUTCFullYear()+"-"+b(l.getUTCMonth()+1)+"-"+b(l.getUTCDate())+
"T"+b(l.getUTCHours())+":"+b(l.getUTCMinutes())+":"+b(l.getUTCSeconds())+'Z"':"null";case "[object Array]":f=l.length;g=[];for(d=0;d<f;d++)g.push(h(d,l)||"null");return"["+g.join(",")+"]";default:g=[];for(d in l)G.call(l,d)&&(f=h(d,l))&&g.push(a(d)+":"+f);return"{"+g.join(",")+"}"}}}("",{"":c})};f.corsable="withCredentials"in f.xhr();f.browser=function(){var c=H.userAgent.toLowerCase(),a={},c=/(msie) ([\w.]+)/.exec(c)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(c)||0>c.indexOf("android")&&/version\/(.+) (safari)/.exec(c)||
[];"safari"===c[2]&&(c[2]=c[1],c[1]="safari");a[c[1]||""]=!0;a.version=c[2]||"0";a.vmajor=a.version.split(".")[0];a.trident&&(a.msie=!0);return a}();var m={base:function(c){var a={open:function(){function b(){clearTimeout(e)}a.connect();var e=setTimeout(function(){a.fire("error",Error("timeout")).close()},c.timeout);a.on("open",b).on("close",b)}},b={open:p(!0),message:p(),error:p(),close:p(!0)};a.on=function(a,c){b[a].add(c);return this};a.off=function(a,c){b[a].remove(c);return this};a.fire=function(c){b[c].fire(a,
B.call(arguments,1));return this};return a},ws:function(c){var a=g.WebSocket;if(a){var b,d=m.base(c);d.connect=function(){b=new a(c.url.replace(/^http/,"ws"));b.onopen=function(){d.fire("open")};b.onmessage=function(a){d.fire("message",a.data)};b.onerror=function(){d.fire("error",Error()).fire("close")};b.onclose=function(){d.fire("close")}};d.send=function(a){b.send(a)};d.close=function(){b.close()};return d}},httpbase:function(c){var a=m.base(c);a.uri={open:function(){return f.stringifyURI(c.url,
{when:"open",transport:c.transport})},send:function(){return f.stringifyURI(c.url,{id:a.id})}};var b;a.on("open",function(){b=!0}).on("close",function(){b=!1});a.send=!c.crossOrigin||f.corsable?function(c){var d=f.xhr();d.onreadystatechange=function(){4===d.readyState&&200!==d.status&&b&&a.send(c)};d.open("POST",a.uri.send());d.setRequestHeader("content-type","text/plain; charset=UTF-8");f.corsable&&(d.withCredentials=!0);d.send("data="+c)}:g.XDomainRequest&&c.xdrURL?function(e){var d=new g.XDomainRequest;
d.onerror=function(){b&&a.send(e)};d.open("POST",c.xdrURL.call(a,a.uri.send()));d.send("data="+e)}:function(c){var d,h=r.createElement("form");h.action=a.uri.send();h.target="socket-"+v++;h.method="POST";h.enctype=h.encoding="text/plain";h.acceptCharset="UTF-8";h.style.display="none";h.innerHTML='<textarea name="data"></textarea><iframe name="'+h.target+'"></iframe>';h.firstChild.value=c;d=h.lastChild;f.on(d,"error",function(){b&&a.send(c)});f.on(d,"load",function(){r.body.removeChild(h)});r.body.appendChild(h);
h.submit()};var d;a.close=function(){a.abort();if(!d){d=!0;var b=r.createElement("script");b.async=!1;b.src=f.stringifyURI(c.url,{id:a.id,when:"abort"});b.onload=b.onerror=b.onreadystatechange=function(){if(!b.readyState||/loaded|complete/.test(b.readyState))b.onload=b.onreadystatechange=null,b.parentNode&&b.parentNode.removeChild(b),a.fire("close")};z.insertBefore(b,z.firstChild)}};return a},stream:function(c){return m.sse(c)||m.streamxhr(c)||m.streamxdr(c)||m.streamiframe(c)},sse:function(c){var a=
g.EventSource;if(a&&!(c.crossOrigin&&f.browser.safari&&7>f.browser.vmajor)){var b,d=m.httpbase(c);d.connect=function(){b=new a(d.uri.open()+"&sse=true",{withCredentials:!0});var c;b.onmessage=function(a){c?d.fire("message",a.data):(c=!0,a=f.parseURI(a.data).query,d.id=a.id,d.fire("open"))};b.onerror=function(){b.close();d.fire("close")}};d.abort=function(){b.close()};return d}},streambase:function(c){var a="",b=m.httpbase(c),d;b.parse=function(c){if(c=c.replace(/^\s+/,"")){c=(a+c).split("\n\n");for(var k=
0;k<c.length-1;k++){var h=c[k].substring(6);d?b.fire("message",h):(d=!0,h=f.parseURI(h).query,b.id=h.id,b.fire("open"))}a=c[c.length-1]}};return b},streamxhr:function(c){if(!(f.browser.msie&&10>f.browser.vmajor||c.crossOrigin&&!f.corsable)){var a,b=m.streambase(c);b.connect=function(){var c;a=f.xhr();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(b.parse(c?a.responseText.substring(c):a.responseText),c=a.responseText.length):4===a.readyState&&(200!==a.status&&b.fire("error",Error()),
b.fire("close"))};a.open("GET",b.uri.open());f.corsable&&(a.withCredentials=!0);a.send()};b.abort=function(){a.abort()};return b}},streamxdr:function(c){var a=g.XDomainRequest;if(a&&c.xdrURL){var b,d=m.streambase(c);d.connect=function(){var e;b=new a;b.onprogress=function(){d.parse(e?b.responseText.substring(e):b.responseText);e=b.responseText.length};b.onerror=function(){d.fire("error",Error()).fire("close")};b.onload=function(){d.fire("close")};b.open("GET",c.xdrURL.call(d,d.uri.open()));b.send()};
d.abort=function(){b.abort()};return d}},streamiframe:function(c){var a=g.ActiveXObject;if(a&&!c.crossOrigin){var b,d,e=m.streambase(c);e.connect=function(){function c(a){var b;(function x(){b=setTimeout(function(){!1!==a()&&x()},1)})();return function(){clearTimeout(b)}}b=new a("htmlfile");b.open();b.close();var h=b.createElement("iframe");h.src=e.uri.open();b.body.appendChild(h);var f=h.contentDocument||h.contentWindow.document;d=c(function(){function a(){var c=b.cloneNode(!0);c.appendChild(f.createTextNode("."));
c=c.innerText.replace(/\r\n/g,"\n");return c.substring(0,c.length-1)}if(f.firstChild){var b=f.body.lastChild;if(!b)return e.fire("error",Error()).fire("close"),!1;e.parse(a());b.innerText="";d=c(function(){var c=a();c&&(b.innerText="",e.parse(c));if("complete"===f.readyState)return e.fire("close"),!1});return!1}})};e.abort=function(){d();b.execCommand("Stop")};return e}},longpoll:function(c){return m.longpollajax(c)||m.longpollxdr(c)||m.longpolljsonp(c)},longpollbase:function(c){var a=m.httpbase(c);
a.connect=function(){a.poll(a.uri.open(),function(b){b=f.parseURI(b).query;a.id=b.id;(function e(b){a.poll(f.stringifyURI(c.url,{id:a.id,when:"poll",lastMsgId:b}),function(b){b?(b=/(\d+)\|(.*)/.exec(b),e(b[1]),a.fire("message",b[2])):a.fire("close")})})();a.fire("open")})};return a},longpollajax:function(c){if(!c.crossOrigin||f.corsable){var a,b=m.longpollbase(c);b.poll=function(c,e){a=f.xhr();a.onreadystatechange=function(){4===a.readyState&&(200===a.status?e(a.responseText):b.fire("error",Error()))};
a.open("GET",c);f.corsable&&(a.withCredentials=!0);a.send(null)};b.abort=function(){a.abort()};return b}},longpollxdr:function(c){var a=g.XDomainRequest;if(a&&c.xdrURL){var b,d=m.longpollbase(c);d.poll=function(e,f){e=c.xdrURL.call(d,e);b=new a;b.onload=function(){f(b.responseText)};b.onerror=function(){d.fire("error",Error()).fire("close")};b.open("GET",e);b.send()};d.abort=function(){b.abort()};return d}}},C=[];m.longpolljsonp=function(c){var a,b=m.longpollbase(c),d=C.pop()||"socket_"+v++;g[d]=
function(b){a.responseText=b};b.on("close",function(){g[d]=function(){};C.push(d)});var e=b.uri.open;b.uri.open=function(){return e.apply(b,arguments)+"&jsonp=true&callback="+d};b.poll=function(c,d){a=r.createElement("script");a.async=!0;a.src=c;a.clean=function(){a.clean=a.onerror=a.onload=a.onreadystatechange=a.responseText=null;a.parentNode&&a.parentNode.removeChild(a)};a.onload=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.clean&&a.clean(),d(a.responseText)};
a.onerror=function(){a.clean();b.fire("error",Error()).fire("close")};z.insertBefore(a,z.firstChild)};b.abort=function(){a.clean&&a.clean()};return b};var A={},t=[];A.open=function(c,a){var b=w(c,a);t.push(b);return b};A.util=f;A.transports=m;f.on(g,"unload",function(){for(var c,a=0;a<t.length;a++)c=t[a],"closed"!==c.state()&&c.close()});f.on(g,"online",function(){for(var c,a=0;a<t.length;a++)c=t[a],"waiting"===c.state()&&c.open()});f.on(g,"offline",function(){for(var c,a=0;a<t.length;a++)c=t[a],
"opened"===c.state()&&c.fire("error",Error()).fire("close")});return A});