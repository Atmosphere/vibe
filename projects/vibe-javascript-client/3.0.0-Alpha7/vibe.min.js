/* Vibe v3.0.0-Alpha7 | http://vibe-project.github.io/projects/vibe-javascript-client/ | (c) 2014, The Vibe Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(g,p){if("function"===typeof define&&define.amd)define([],function(){return p(g)});else if("object"===typeof exports){var v=require("jsdom").jsdom().parentWindow;v.WebSocket=require("ws");v.EventSource=require("eventsource");module.exports=p(v);module.exports.util.corsable=!0}else g.vibe=p(g)})(this,function(g){function p(b){var c,a,e,d,h,m,f=[],g=function(q,n){n=n||[];a=!b||[q,n];e=!0;m=d||0;d=0;for(h=f.length;m<h&&!c;m++)f[m].apply(q,n);e=!1};return{add:function(b){var m=f.length;f.push(b);
e?h=f.length:!c&&a&&!0!==a&&(d=m,g(a[0],a[1]))},remove:function(a){var b;for(b=0;b<f.length;b++)if(a===f[b]||a.guid&&a.guid===f[b].guid)e&&b<=h&&(h--,b<=m&&m--),f.splice(b--,1)},fire:function(d,h){c||e||b&&a||g(d,h)},lock:function(){c=!0},locked:function(){return!!c},unlock:function(){c=a=e=d=h=m=void 0}}}function v(b,c){var a={reconnect:function(a){return 2*(a||250)},timeout:3E3,xdrURL:null};if(c)for(var e in c)a[e]=c[e];c=a;var d={},h={};d.on=function(a,b){var c;c=h[a];if(!c){if(h.message.locked())return this;
c=h[a]=p();c.order=h.message.order}c.add(b);return this};d.off=function(a,b){var c=h[a];c&&c.remove(b);return this};d.once=function(a,b){function c(){d.off(a,c);b.apply(d,arguments)}b.guid=b.guid||u++;c.guid=b.guid;return d.on(a,c)};d.fire=function(a){var b=h[a];b&&b.fire(d,B.call(arguments,1));return this};var m,w,g,q;d.open=function(){n="preparing";m=null;clearTimeout(w);q&&q++;for(var a in h)h[a].unlock();return d.fire("connecting")};d.close=function(){c.reconnect=!1;clearTimeout(w);m?m.close():
d.fire("close");return this};var n;d.state=function(){return n};for(e in{connecting:1,open:1,close:1,waiting:1})h[e]=p(!0),h[e].order=u++;h.message=p(!1);h.message.order=h.open.order;d.on("connecting",function(){n="connecting";for(var a=f.isArray(b)?B.call(b):[b],h=0;h<a.length;h++){var e=a[h]=f.makeAbsolute(a[h]);/^http:|^https:/.test(e)&&!f.parseURI(e).query.transport&&a.splice(h,1,f.stringifyURI(e,{transport:"ws"}),f.stringifyURI(e,{transport:"stream"}),f.stringifyURI(e,{transport:"longpoll"}))}(function x(){function b(){g.off("close",
x).close()}var h=a.shift();if(h){var e;switch(/^([\w\+\.\-]+):/.exec(h)[1]){case "http":case "https":e=f.parseURI(h).query.transport;break;case "ws":case "wss":e="ws"}var g=l[e](h,c);g?(d.once("close",b),g.open().on("close",x).on("text",function G(a){g.off("text",G);a=f.parseURI(a).query;c.heartbeat=+a.heartbeat;c._heartbeat=+a._heartbeat||5E3;m=g.off("close",x);var h;m.on("text",function(a){if(h){var b=f.parseJSON(a),c;a=function(a){return function(h){c||(c=!0,d.send("reply",{id:b.id,data:h,exception:!a}))}};
a=[b.type,b.data,b.reply?{resolve:a(!0),reject:a(!1)}:null];d.fire.apply(d,a)}else h=!0}).on("error",function(a){d.fire("error",a)}).on("close",function(){d.fire("close")});d.off("close",b).fire("open")})):x()}else d.fire("error",Error()).fire("close")})()}).on("open",function(){n="opened";var a;(function F(){a=setTimeout(function(){d.send("heartbeat").once("heartbeat",function(){clearTimeout(a);F()});a=setTimeout(function(){d.fire("error",Error("heartbeat"));m.close()},c._heartbeat)},c.heartbeat-
c._heartbeat)})();d.once("close",function(){clearTimeout(a)});h.connecting.lock();w=g=q=null}).on("close",function(){n="closed";for(var a in h){var b=h[a];b.order<h.close.order&&b.lock()}if(c.reconnect)d.once("close",function(){q=q||1;g=c.reconnect.call(d,g,q);!1!==g&&(w=setTimeout(function(){d.open()},g),d.fire("waiting",g,q))})}).on("waiting",function(){n="waiting"});var C={};d.send=function(a,b,c,h){if("opened"!==n)return d.fire(Error("notopened")),this;a={id:u++,type:a,data:b,reply:!(!c&&!h)};
a.reply&&(C[a.id]=[c,h]);m.send(f.stringifyJSON(a));return this};d.on("reply",function(a){C[a.id][+a.exception].call(d,a.data);delete C[a.id]});return d.open()}var u=1,B=Array.prototype.slice,D=Object.prototype.toString,H=Object.prototype.hasOwnProperty,r=g.document,y=g.location,I=g.navigator,z=r.head||r.getElementsByTagName("head")[0]||r.documentElement,f={};f.isArray=Array.isArray||function(b){return"[object Array]"===D.call(b)};f.makeAbsolute=function(b){var c=r.createElement("div");c.innerHTML=
'<a href="'+b+'"/>';return encodeURI(decodeURI(c.firstChild.href))};f.on=function(b,c,a){b.addEventListener?b.addEventListener(c,a,!1):b.attachEvent&&b.attachEvent("on"+c,a)};f.off=function(b,c,a){b.removeEventListener?b.removeEventListener(c,a,!1):b.detachEvent&&b.detachEvent("on"+c,a)};f.stringifyURI=function(b,c){var a,e=[];c=c||{};c._=u++;for(a in c)null!=c[a]&&e.push(encodeURIComponent(a)+"="+encodeURIComponent(c[a]));return b+(/\?/.test(b)?"&":"?")+e.join("&").replace(/%20/g,"+")};f.parseURI=
function(b){var c={query:{}};if(b=/.*\?([^#]*)/.exec(b)){b=b[1].split("&");for(var a=0;a<b.length;a++){var e=b[a].split("=");c.query[decodeURIComponent(e[0])]=decodeURIComponent(e[1]||"")}}return c};f.xhr=function(){try{return new g.XMLHttpRequest}catch(b){try{return new g.ActiveXObject("Microsoft.XMLHTTP")}catch(c){}}};f.parseJSON=g.JSON?g.JSON.parse:function(b){return Function("return "+b)()};f.stringifyJSON=g.JSON?g.JSON.stringify:function(b){function c(a){return'"'+a.replace(e,function(a){var b=
d[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function a(a){return 10>a?"0"+a:a}var e=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,d={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function m(b,e){var d,f,g,k=e[b];g=typeof k;k&&"object"===typeof k&&"function"===typeof k.toJSON&&(k=k.toJSON(b),g=typeof k);switch(g){case "string":return c(k);
case "number":return isFinite(k)?String(k):"null";case "boolean":return String(k);case "object":if(!k)return"null";switch(D.call(k)){case "[object Date]":return isFinite(k.valueOf())?'"'+k.getUTCFullYear()+"-"+a(k.getUTCMonth()+1)+"-"+a(k.getUTCDate())+"T"+a(k.getUTCHours())+":"+a(k.getUTCMinutes())+":"+a(k.getUTCSeconds())+'Z"':"null";case "[object Array]":f=k.length;g=[];for(d=0;d<f;d++)g.push(m(d,k)||"null");return"["+g.join(",")+"]";default:g=[];for(d in k)H.call(k,d)&&(f=m(d,k))&&g.push(c(d)+
":"+f);return"{"+g.join(",")+"}"}}}("",{"":b})};f.corsable="withCredentials"in f.xhr();f.browser=function(){var b=I.userAgent.toLowerCase(),c={},b=/(msie) ([\w.]+)/.exec(b)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(b)||0>b.indexOf("android")&&/version\/(.+) (safari)/.exec(b)||[];"safari"===b[2]&&(b[2]=b[1],b[1]="safari");c[b[1]||""]=!0;c.version=b[2]||"0";c.vmajor=c.version.split(".")[0];c.trident&&(c.msie=!0);return c}();f.crossOrigin=function(b){b=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(b.toLowerCase());
return!(!b||b[1]==y.protocol&&b[2]==y.hostname&&(b[3]||("http:"===b[1]?80:443))==(y.port||("http:"===y.protocol?80:443)))};var l={base:function(b,c){var a={open:function(){function b(){clearTimeout(h)}a.connect();var h=setTimeout(function(){a.fire("error",Error("timeout")).close()},c.timeout);a.on("open",b).on("close",b);return this}},e={open:p(!0),text:p(),error:p(),close:p(!0)};a.on=function(a,b){e[a].add(b);return this};a.off=function(a,b){e[a].remove(b);return this};a.fire=function(b){e[b].fire(a,
B.call(arguments,1));return this};return a},ws:function(b,c){var a=g.WebSocket;if(a){var e,d=l.base(b,c);d.connect=function(){e=new a(b.replace(/^http/,"ws"));e.onopen=function(){d.fire("open")};e.onmessage=function(a){"string"===typeof a.data&&d.fire("text",a.data)};e.onerror=function(){d.fire("error",Error()).fire("close")};e.onclose=function(){d.fire("close")}};d.send=function(a){e.send(a)};d.close=function(){e.close()};return d}},httpbase:function(b,c){var a=l.base(b,c),e;a.on("open",function(){e=
f.stringifyURI(b,{id:a.id})}).on("close",function(){e=null});a.send=!f.crossOrigin(b)||f.corsable?function(b){var c=f.xhr();c.onreadystatechange=function(){4===c.readyState&&200!==c.status&&e&&a.send(b)};c.open("POST",e);c.setRequestHeader("content-type","text/plain; charset=UTF-8");f.corsable&&(c.withCredentials=!0);c.send("data="+b)}:g.XDomainRequest&&c.xdrURL?function(b){var d=new g.XDomainRequest;d.onerror=function(){e&&a.send(b)};d.open("POST",c.xdrURL.call(a,e));d.send("data="+b)}:function(b){var c,
d=r.createElement("form");d.action=e;d.target="socket-"+u++;d.method="POST";d.enctype=d.encoding="text/plain";d.acceptCharset="UTF-8";d.style.display="none";d.innerHTML='<textarea name="data"></textarea><iframe name="'+d.target+'"></iframe>';d.firstChild.value=b;c=d.lastChild;f.on(c,"error",function(){e&&a.send(b)});f.on(c,"load",function(){r.body.removeChild(d)});r.body.appendChild(d);d.submit()};var d;a.close=function(){a.abort();if(!d){d=!0;var c=r.createElement("script");c.async=!1;c.src=f.stringifyURI(b,
{id:a.id,when:"abort"});c.onload=c.onerror=c.onreadystatechange=function(){if(!c.readyState||/loaded|complete/.test(c.readyState))c.onload=c.onreadystatechange=null,c.parentNode&&c.parentNode.removeChild(c),a.fire("close")};z.insertBefore(c,z.firstChild)}};return a},stream:function(b,c){return l.sse(b,c)||l.streamxhr(b,c)||l.streamxdr(b,c)||l.streamiframe(b,c)},sse:function(b,c){var a=g.EventSource;if(a&&!(f.crossOrigin(b)&&f.browser.safari&&7>f.browser.vmajor)){var e,d=l.httpbase(b,c);d.connect=
function(){e=new a(b+"&when=open&sse=true",{withCredentials:!0});var c;e.onmessage=function(a){c?d.fire("text",a.data):(c=!0,a=f.parseURI(a.data).query,d.id=a.id,d.fire("open"))};e.onerror=function(){e.close();d.fire("close")}};d.abort=function(){e.close()};return d}},streambase:function(b,c){var a="",e=l.httpbase(b,c),d;e.parse=function(b){if(b=b.replace(/^\s+/,"")){b=(a+b).split("\n\n");for(var c=0;c<b.length-1;c++){var g=b[c].substring(6);d?e.fire("text",g):(d=!0,g=f.parseURI(g).query,e.id=g.id,
e.fire("open"))}a=b[b.length-1]}};return e},streamxhr:function(b,c){if(!(f.browser.msie&&10>f.browser.vmajor||f.crossOrigin(b)&&!f.corsable)){var a,e=l.streambase(b,c);e.connect=function(){var c;a=f.xhr();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(e.parse(c?a.responseText.substring(c):a.responseText),c=a.responseText.length):4===a.readyState&&(200!==a.status&&e.fire("error",Error()),e.fire("close"))};a.open("GET",b+"&when=open");f.corsable&&(a.withCredentials=!0);a.send()};
e.abort=function(){a.abort()};return e}},streamxdr:function(b,c){var a=g.XDomainRequest;if(a&&c.xdrURL){var e,d=l.streambase(b,c);d.connect=function(){var h;e=new a;e.onprogress=function(){d.parse(h?e.responseText.substring(h):e.responseText);h=e.responseText.length};e.onerror=function(){d.fire("error",Error()).fire("close")};e.onload=function(){d.fire("close")};e.open("GET",c.xdrURL.call(d,b+"&when=open"));e.send()};d.abort=function(){e.abort()};return d}},streamiframe:function(b,c){var a=g.ActiveXObject;
if(a&&!f.crossOrigin(b)){var e,d,h=l.streambase(b,c);h.connect=function(){function c(a){var b;(function k(){b=setTimeout(function(){!1!==a()&&k()},1)})();return function(){clearTimeout(b)}}e=new a("htmlfile");e.open();e.close();var f=e.createElement("iframe");f.src=b+"&when=open";e.body.appendChild(f);var g=f.contentDocument||f.contentWindow.document;d=c(function(){function a(){var c=b.cloneNode(!0);c.appendChild(g.createTextNode("."));c=c.innerText.replace(/\r\n/g,"\n");return c.substring(0,c.length-
1)}if(g.firstChild){var b=g.body.lastChild;if(!b)return h.fire("error",Error()).fire("close"),!1;h.parse(a());b.innerText="";d=c(function(){var c=a();c&&(b.innerText="",h.parse(c));if("complete"===g.readyState)return h.fire("close"),!1});return!1}})};h.abort=function(){d();e.execCommand("Stop")};return h}},longpoll:function(b,c){return l.longpollajax(b,c)||l.longpollxdr(b,c)||l.longpolljsonp(b,c)},longpollbase:function(b,c){var a=l.httpbase(b,c);a.connect=function(){a.poll(b+"&when=open",function(c){c=
f.parseURI(c).query;a.id=c.id;(function h(){a.poll(f.stringifyURI(b,{id:a.id,when:"poll"}),function(b){b?(h(),a.fire("text",b)):a.fire("close")})})();a.fire("open")})};return a},longpollajax:function(b,c){if(!f.crossOrigin(b)||f.corsable){var a,e=l.longpollbase(b,c);e.poll=function(b,c){a=f.xhr();a.onreadystatechange=function(){4===a.readyState&&(200===a.status?c(a.responseText):e.fire("error",Error()))};a.open("GET",b);f.corsable&&(a.withCredentials=!0);a.send(null)};e.abort=function(){a.abort()};
return e}},longpollxdr:function(b,c){var a=g.XDomainRequest;if(a&&c.xdrURL){var e,d=l.longpollbase(b,c);d.poll=function(b,f){b=c.xdrURL.call(d,b);e=new a;e.onload=function(){f(e.responseText)};e.onerror=function(){d.fire("error",Error()).fire("close")};e.open("GET",b);e.send()};d.abort=function(){e.abort()};return d}}},E=[];l.longpolljsonp=function(b,c){var a,e=l.longpollbase(b,c),d=E.pop()||"socket_"+u++;g[d]=function(b){a.responseText=b};e.on("close",function(){g[d]=function(){};E.push(d)});e.poll=
function(b,c){a=r.createElement("script");a.async=!0;a.src=f.stringifyURI(b,{jsonp:"true",callback:d});a.clean=function(){a.clean=a.onerror=a.onload=a.onreadystatechange=a.responseText=null;a.parentNode&&a.parentNode.removeChild(a)};a.onload=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.clean&&a.clean(),c(a.responseText)};a.onerror=function(){a.clean();e.fire("error",Error()).fire("close")};z.insertBefore(a,z.firstChild)};e.abort=function(){a.clean&&a.clean()};
return e};var A={},t=[];A.open=function(b,c){var a=v(b,c);t.push(a);return a};A.util=f;A.transports=l;f.on(g,"unload",function(){for(var b,c=0;c<t.length;c++)b=t[c],"closed"!==b.state()&&b.close()});f.on(g,"online",function(){for(var b,c=0;c<t.length;c++)b=t[c],"waiting"===b.state()&&b.open()});f.on(g,"offline",function(){for(var b,c=0;c<t.length;c++)b=t[c],"opened"===b.state()&&b.fire("error",Error()).fire("close")});return A});